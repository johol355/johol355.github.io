<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.306">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-04-26">

<title>Modeling mortality risk in transferred patients</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="risk-model_files/libs/clipboard/clipboard.min.js"></script>
<script src="risk-model_files/libs/quarto-html/quarto.js"></script>
<script src="risk-model_files/libs/quarto-html/popper.min.js"></script>
<script src="risk-model_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="risk-model_files/libs/quarto-html/anchor.min.js"></script>
<link href="risk-model_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="risk-model_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="risk-model_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="risk-model_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="risk-model_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#main-questions" id="toc-main-questions" class="nav-link active" data-scroll-target="#main-questions"><span class="header-section-number">1</span> Main questions</a></li>
  <li><a href="#modeling-choices" id="toc-modeling-choices" class="nav-link" data-scroll-target="#modeling-choices"><span class="header-section-number">2</span> Modeling choices</a>
  <ul class="collapse">
  <li><a href="#model-2" id="toc-model-2" class="nav-link" data-scroll-target="#model-2"><span class="header-section-number">2.1</span> Model 2</a></li>
  <li><a href="#model-3" id="toc-model-3" class="nav-link" data-scroll-target="#model-3"><span class="header-section-number">2.2</span> Model 3</a></li>
  <li><a href="#model-4" id="toc-model-4" class="nav-link" data-scroll-target="#model-4"><span class="header-section-number">2.3</span> Model 4</a></li>
  </ul></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">3</span> Data preparation</a></li>
  <li><a href="#model-1-risk-prediction-of-d30-mortality-given-pre-transfer-status" id="toc-model-1-risk-prediction-of-d30-mortality-given-pre-transfer-status" class="nav-link" data-scroll-target="#model-1-risk-prediction-of-d30-mortality-given-pre-transfer-status"><span class="header-section-number">4</span> Model 1: Risk prediction of d30 mortality given pre transfer status</a>
  <ul class="collapse">
  <li><a href="#model-1.1" id="toc-model-1.1" class="nav-link" data-scroll-target="#model-1.1"><span class="header-section-number">4.1</span> Model 1.1</a></li>
  <li><a href="#model-1.2" id="toc-model-1.2" class="nav-link" data-scroll-target="#model-1.2"><span class="header-section-number">4.2</span> Model 1.2</a></li>
  <li><a href="#posteriors-of-model-1-parameters" id="toc-posteriors-of-model-1-parameters" class="nav-link" data-scroll-target="#posteriors-of-model-1-parameters"><span class="header-section-number">4.3</span> Posteriors of model 1 parameters</a></li>
  </ul></li>
  <li><a href="#model-2-1" id="toc-model-2-1" class="nav-link" data-scroll-target="#model-2-1"><span class="header-section-number">5</span> Model 2</a></li>
  <li><a href="#model-3-1" id="toc-model-3-1" class="nav-link" data-scroll-target="#model-3-1"><span class="header-section-number">6</span> Model 3</a>
  <ul class="collapse">
  <li><a href="#model-3.1" id="toc-model-3.1" class="nav-link" data-scroll-target="#model-3.1"><span class="header-section-number">6.1</span> Model 3.1</a></li>
  <li><a href="#model-3.2" id="toc-model-3.2" class="nav-link" data-scroll-target="#model-3.2"><span class="header-section-number">6.2</span> Model 3.2</a></li>
  <li><a href="#posteriors-of-model-3-parameters" id="toc-posteriors-of-model-3-parameters" class="nav-link" data-scroll-target="#posteriors-of-model-3-parameters"><span class="header-section-number">6.3</span> Posteriors of model 3 parameters</a></li>
  </ul></li>
  <li><a href="#model-4-1" id="toc-model-4-1" class="nav-link" data-scroll-target="#model-4-1"><span class="header-section-number">7</span> Model 4</a></li>
  <li><a href="#what-did-we-learn" id="toc-what-did-we-learn" class="nav-link" data-scroll-target="#what-did-we-learn"><span class="header-section-number">8</span> What did we learn?</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Modeling mortality risk in transferred patients</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Johan Olsson </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 26, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="main-questions" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="main-questions"><span class="header-section-number">1</span> Main questions</h2>
<p>The idea here is to answer these questions:</p>
<ol type="1">
<li>What pre-transfer variables are associated with 30-day mortality in transferred patients?</li>
<li>Are there any differences in risk factors in transferred vs.&nbsp;non-transferred (patients directly admittited to a tertiary center ICU)?</li>
<li>Is transfer distance a risk factor for 30-day mortality in transferred patients?</li>
<li>Is time in the primary icu a risk factor for 30-day mortality in transferred patients?</li>
</ol>
<p>In answering question 1 a rather bland risk model will be built. It is unlikely that anything new will be discovered. Rather, see this model as a predecessor of the model needed to answer question 2.</p>
<p>By answering question 2, subgroups of patients at high risk of poor outcome can potentially be identified where transfer status acts as a modifier of risk. Such findings would be largely hypothesis generating, as the dataset does not allow for more detailed inquiry. Under the assumtion of no residual confounding, differences depending on transfer status could be explained by the intial care at the primary center, the transfer process or delays to treatment. Clear findings cloud help to identify areas of special interest for future research. As of today (May 2024) the dataset does not allow for this analyis, as there is no way of telling which tertiary ICU patients were directly admitted. We will have to wait for the supplemented data (expected to arrive in summer-fall of 2024).</p>
<p>Question 3 is tricky. Since hospitals are fixed in space, transfer distance becomes as much a surrogate for the sending and receiving centers, as it is a surrogate for the transfer time and the logistics involved in transferring a patient between hospitals. Therefore, any findings are largely hypothesis generating given the nature of the dataset.</p>
</section>
<section id="modeling-choices" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="modeling-choices"><span class="header-section-number">2</span> Modeling choices</h2>
<p>Generally, bayesian linear hierarchcial models are applied in order to make model intrepretation relatively straightforward. ### Model 1 Here a set of potentially predictive parameters will be used in a generalized linear model. I will test two variations of the model. Both will have a varying intercept with parameters drawn from a common prior. Model 1.1. will imputed missing data from a common prior distribution, where as Model 1.2 will impute the concioussness level predictor from separate distributions for the respective diagnostic group. The latter model (Model 1.2) samples very slow (2+ hours) due to the compound steps in sampling. This is prohibitive of constructing a model with more dynamic missing data handling and varying slopes for all predcitors. Also, divergences start to appear even though the parameterization is non-centered.</p>
<section id="model-2" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="model-2"><span class="header-section-number">2.1</span> Model 2</h3>
<p>This model builds on model 1. A natural way to extend this model would be to add another level in the hierarchical structure: transferred vs.&nbsp;non-transferred patient. As of today, there is not enough data to construct these models.</p>
</section>
<section id="model-3" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="model-3"><span class="header-section-number">2.2</span> Model 3</h3>
<p>This idea here is to use distance as a predictor of outcome in a hierarchical model where a level is the receiving tertiary center (model 3.1) or diagnostic group (model 3.2). I will test the implications of using standardized road distance as a linear predictor.</p>
</section>
<section id="model-4" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="model-4"><span class="header-section-number">2.3</span> Model 4</h3>
<p>The idea here is to use time-in-primary-icu as a predictor of outcome in a hierarchical model. Sending centers are a level in this model.</p>
</section>
</section>
<section id="data-preparation" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="data-preparation"><span class="header-section-number">3</span> Data preparation</h2>
<p>The database is queried. All analysis is done on patients undergoing transfers &gt; 49 km. Only centers transferring five or more patients are included.</p>
<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load dependencies</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlalchemy</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy <span class="im">import</span> create_engine, text</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> zscore</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the SQLalchemy engine</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>engine <span class="op">=</span> create_engine(<span class="ss">f"sqlite:////Users/JO/PhD/neurocritical-transfers/data/db.sqlite"</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the SQL query from the file</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'/Users/JO/PhD/neurocritical-transfers/notes/final-analysis/0-database-query/primary-based-transfer-query.sql'</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute the query</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> pd.read_sql(query, engine)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Remmap receiving hospital codes to names</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>hospitals_map <span class="op">=</span> {<span class="st">"11001"</span>: <span class="st">"Karolinska universitetssjukhuset, Solna"</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a> <span class="st">"11003"</span>: <span class="st">"Karolinska universitetssjukhuset, Solna"</span>,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a> <span class="st">"51001"</span>: <span class="st">"Sahlgrenska universitetssjukhuset"</span>,</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a> <span class="st">"12001"</span>: <span class="st">"Akademiska sjukhuset"</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a> <span class="st">"21001"</span>: <span class="st">"Universitetssjukhuset i Linköping"</span>,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a> <span class="st">"64001"</span>: <span class="st">"Norrlands universitetssjukhus"</span>,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a> <span class="st">"41001"</span>: <span class="st">"Universitetssjukhuset i Lund"</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a> <span class="st">"41002"</span>: <span class="st">"Universitetssjukhuset i Lund"</span>}</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>d[<span class="st">'tertiary_center'</span>] <span class="op">=</span> d.tertiary_center_id.<span class="bu">map</span>(hospitals_map)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix admission time so that time zone is clear, also add a admission time in UTC for later merging of data</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>d[<span class="st">"sir_adm_time"</span>] <span class="op">=</span> pd.to_datetime(d[<span class="st">"sir_adm_time"</span>], unit<span class="op">=</span><span class="st">'s'</span>).dt.tz_localize(<span class="st">'Europe/Stockholm'</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>d[<span class="st">'admission_time_utc'</span>] <span class="op">=</span> d[<span class="st">"sir_adm_time"</span>].dt.tz_convert(<span class="st">'UTC'</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Load dataframes of formatted ICU names and ICU to airport mappings</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>icu_names <span class="op">=</span> pd.read_csv(<span class="st">'/Users/JO/PhD/neurocritical-transfers/data/icu-mapping-names-only.csv'</span>, sep<span class="op">=</span><span class="st">";"</span>)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Remap ICU names to properly formatted ICU names</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>icu_names_dict <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(icu_names[<span class="st">'sir_icu_name'</span>], icu_names[<span class="st">'formatted_icu_name'</span>]))</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>d[<span class="st">'formatted_icu_name'</span>] <span class="op">=</span> d.sir_icu_name.<span class="bu">map</span>(icu_names_dict)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with road distance data</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> pd.read_csv(<span class="st">'/Users/JO/PhD/neurocritical-transfers/data/road_distance.csv'</span>, sep<span class="op">=</span><span class="st">";"</span>)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>d[<span class="st">'road_distance'</span>] <span class="op">=</span> [r[r[<span class="st">'formatted_icu_name'</span>] <span class="op">==</span> p][t].values[<span class="dv">0</span>] <span class="cf">for</span> (p, t) <span class="kw">in</span> <span class="bu">zip</span>(d.formatted_icu_name, d.tertiary_center)]</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter on distance &gt; 49 km and n=5 per center</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>d_filtered <span class="op">=</span> d[d[<span class="st">'road_distance'</span>] <span class="op">&gt;</span> <span class="dv">49</span>]</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>grouped <span class="op">=</span> d_filtered.groupby(<span class="st">'sir_icu_name'</span>)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter groups where the count is greater than or equal to 5</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>d_filtered <span class="op">=</span> grouped.<span class="bu">filter</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(x) <span class="op">&gt;=</span> <span class="dv">5</span>)</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Ungroup the DataFrame</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>d_filtered <span class="op">=</span> d_filtered.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Redefine to d</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> d_filtered</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Assert that dataframe is of correct length</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span>(<span class="bu">len</span>(d) <span class="op">==</span> <span class="dv">6241</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="model-1-risk-prediction-of-d30-mortality-given-pre-transfer-status" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="model-1-risk-prediction-of-d30-mortality-given-pre-transfer-status"><span class="header-section-number">4</span> Model 1: Risk prediction of d30 mortality given pre transfer status</h2>
<p>Predictors:</p>
<ul>
<li><p>Sex</p></li>
<li><p>Age (standardized)</p></li>
<li><p>SAPS conciousness level</p></li>
<li><p>SAPS hypotension (min SBP &lt;90)</p></li>
<li><p>SAPS hypothermia (temp &lt;35)</p></li>
<li><p>SAPS acidosis (pH &lt;7.25)</p></li>
<li><p>SAPS hypoxia (PO2 &lt;8 kPa)</p></li>
<li><p>After-hours admission (yes or no)</p></li>
</ul>
<p>Outcome:</p>
<ul>
<li>30-day mortality</li>
</ul>
<p>Levels: * Dx group</p>
<p>Model structure:</p>
<p><span class="math inline">y_{i} \sim Bernoulli(p_{i})</span></p>
<p><span class="math inline">\text{invlogit}(p_{i}) = \beta_{j,0} + \sum_{k=1}^{n_{k}} \beta_{j,k} \cdot x_{k,i}</span></p>
<p>With <span class="math inline">i</span> samples, <span class="math inline">j</span> diagnostic groups, <span class="math inline">k</span> classes of predictors and <span class="math inline">x_{k,i}</span> predictor values. (Notation might be off…)</p>
<p>Priors generally look like:</p>
<p><span class="math inline">\beta_{j,0} \sim Normal(\bar{\mu_{0}}, \bar{\sigma_{0}})</span></p>
<p><span class="math inline">\bar{\mu_{0}}&nbsp;\sim Normal(0, 1)</span></p>
<p><span class="math inline">\bar{\sigma_{0}} \sim Exp(1)</span></p>
<p><span class="math inline">\beta_{j,k} \sim Normal(\bar{\mu_{k}}, \bar{\sigma_{k}})</span></p>
<p><span class="math inline">\bar{\mu_{k}} \sim Normal(0, 1)</span></p>
<p><span class="math inline">\bar{\sigma_{k}} \sim Exp(1)</span></p>
<section id="model-1.1" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="model-1.1"><span class="header-section-number">4.1</span> Model 1.1</h3>
<div class="cell" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>COORDS <span class="op">=</span> {<span class="st">'sample'</span>: np.arange(<span class="bu">len</span>(d)), <span class="st">'dx'</span>: pd.factorize(d[<span class="st">'DX'</span>], use_na_sentinel<span class="op">=</span><span class="va">False</span>, sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'sir_consciousness_level'</span>: pd.factorize(d[<span class="st">'sir_consciousness_level'</span>], use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>]}</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>COORDS) <span class="im">as</span> m1_1:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    idx_dx, _ <span class="op">=</span> pd.factorize(d[<span class="st">'DX'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    female <span class="op">=</span> d[<span class="st">'sex_female'</span>]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    icu_admission_afterhours <span class="op">=</span> d[<span class="st">'icu_admission_afterhours'</span>]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    conciousness, _ <span class="op">=</span> pd.factorize(d.sir_consciousness_level, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    conciousness <span class="op">=</span> np.ma.masked_equal(conciousness, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    hypotension, _ <span class="op">=</span> pd.factorize(d.SAPS_hypotension, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    hypotension  <span class="op">=</span> np.ma.masked_equal(hypotension, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    hypothermia, _ <span class="op">=</span> pd.factorize(d.SAPS_hypothermia, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    hypothermia  <span class="op">=</span> np.ma.masked_equal(hypothermia, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    hypoxia, _ <span class="op">=</span> pd.factorize(d.SAPS_hypoxia, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    hypoxia  <span class="op">=</span> np.ma.masked_equal(hypoxia, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    acidosis, _ <span class="op">=</span> pd.factorize(d.SAPS_acidosis, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    acidosis  <span class="op">=</span> np.ma.masked_equal(acidosis, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    age <span class="op">=</span> zscore(d[<span class="st">'age'</span>])</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Varying intercept with non-centered parameterization</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    mu_bar0 <span class="op">=</span> pm.Normal(<span class="st">'alpha_bar0'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    sigma_bar0 <span class="op">=</span> pm.Exponential(<span class="st">'sigma_bar0'</span>, <span class="dv">1</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    z_beta0 <span class="op">=</span> pm.Normal(<span class="st">'z_beta0'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    beta_0 <span class="op">=</span> pm.Deterministic(<span class="st">'beta_0'</span>, mu_bar0 <span class="op">+</span> z_beta0 <span class="op">*</span> sigma_bar0, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for female (0/1)</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    beta_female <span class="op">=</span> pm.Normal(<span class="st">'beta_female'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for afterhours (0/1) </span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    beta_icu_admission_afterhours <span class="op">=</span> pm.Normal(<span class="st">'beta_icu_admission_afterhours'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for std_age</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    beta_age <span class="op">=</span> pm.Normal(<span class="st">'beta_age'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># intercepts for for (categorical) conciousness level with missing data handling</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    p_con <span class="op">=</span> pm.Dirichlet(<span class="st">'p_con'</span>, a<span class="op">=</span>np.ones(<span class="dv">5</span>), dims<span class="op">=</span>(<span class="st">'sir_consciousness_level'</span>))</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    conciousness_imputed <span class="op">=</span> pm.Categorical(<span class="st">'con_imputed'</span>, p<span class="op">=</span>p_con, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>conciousness)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    beta_conciousness <span class="op">=</span> pm.Normal(<span class="st">'beta_conciousness'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sir_consciousness_level'</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for hypotension with missing data handling (non hierarchical imputation) </span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    p_hypotension <span class="op">=</span> pm.Normal(<span class="st">'p_hypotension'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    hypotension_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'hypotension_imputed'</span>, logit_p<span class="op">=</span>p_hypotension, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>hypotension)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    beta_hypotension <span class="op">=</span> pm.Normal(<span class="st">'beta_hypotension'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for hypothermia with missing data handling (non hierarchical imputation)</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    p_hypothermia <span class="op">=</span> pm.Normal(<span class="st">'p_hypothermia'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    hypothermia_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'hypothermia_imputed'</span>, logit_p<span class="op">=</span>p_hypothermia, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>hypothermia)</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    beta_hypothermia <span class="op">=</span> pm.Normal(<span class="st">'beta_hypothermia'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for hypoxia with missing data handling (non hierarchical imputation)</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    p_hypoxia <span class="op">=</span> pm.Normal(<span class="st">'p_hypoxia'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    hypoxia_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'hypoxia_imputed'</span>, logit_p<span class="op">=</span>p_hypoxia, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>hypoxia)</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    beta_hypoxia <span class="op">=</span> pm.Normal(<span class="st">'beta_hypoxia'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for acidosis with missing data handling (non hierarchical imputation)</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    p_acidosis <span class="op">=</span> pm.Normal(<span class="st">'p_acidosis'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    acidosis_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'acidosis_imputed'</span>, logit_p<span class="op">=</span>p_acidosis, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>acidosis)</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    beta_acidosis <span class="op">=</span> pm.Normal(<span class="st">'beta_acidosis'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    p_i <span class="op">=</span> pm.Deterministic(<span class="st">'p_i'</span>, beta_0[idx_dx] <span class="op">+</span> beta_female <span class="op">*</span> female <span class="op">+</span> beta_icu_admission_afterhours <span class="op">*</span> icu_admission_afterhours <span class="op">+</span> beta_age <span class="op">*</span> age <span class="op">+</span> beta_conciousness[conciousness_imputed] <span class="op">+</span> beta_hypotension <span class="op">*</span> hypotension_imputed <span class="op">+</span> beta_hypothermia <span class="op">*</span> hypothermia_imputed <span class="op">+</span> beta_hypoxia <span class="op">*</span> hypoxia_imputed <span class="op">+</span> beta_acidosis <span class="op">*</span> acidosis_imputed, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> pm.Bernoulli(<span class="st">'Y'</span>, logit_p<span class="op">=</span>p_i, observed<span class="op">=</span>d[<span class="st">'d30'</span>], dims<span class="op">=</span><span class="st">'sample'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in con_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in hypotension_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in hypothermia_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in hypoxia_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in acidosis_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> m1_1:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    idata_1_1 <span class="op">=</span> pm.sample()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Multiprocess sampling (4 chains in 4 jobs)
CompoundStep
&gt;NUTS: [alpha_bar0, sigma_bar0, z_beta0, beta_female, beta_icu_admission_afterhours, beta_age, p_con, beta_conciousness, p_hypotension, beta_hypotension, p_hypothermia, beta_hypothermia, p_hypoxia, beta_hypoxia, p_acidosis, beta_acidosis]
&gt;CategoricalGibbsMetropolis: [con_imputed_unobserved]
&gt;BinaryGibbsMetropolis: [hypotension_imputed_unobserved, hypothermia_imputed_unobserved, hypoxia_imputed_unobserved, acidosis_imputed_unobserved]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 4752 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 1:19:12&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
</section>
<section id="model-1.2" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="model-1.2"><span class="header-section-number">4.2</span> Model 1.2</h3>
<div class="cell" data-execution_count="4">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>COORDS <span class="op">=</span> {<span class="st">'sample'</span>: np.arange(<span class="bu">len</span>(d)), <span class="st">'dx'</span>: pd.factorize(d[<span class="st">'DX'</span>], use_na_sentinel<span class="op">=</span><span class="va">False</span>, sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'sir_consciousness_level'</span>: pd.factorize(d[<span class="st">'sir_consciousness_level'</span>], use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>]}</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>COORDS) <span class="im">as</span> m1_2:</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    idx_dx, _ <span class="op">=</span> pd.factorize(d[<span class="st">'DX'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    female <span class="op">=</span> d[<span class="st">'sex_female'</span>]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    icu_admission_afterhours <span class="op">=</span> d[<span class="st">'icu_admission_afterhours'</span>]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    age <span class="op">=</span> zscore(d[<span class="st">'age'</span>])</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    conciousness, _ <span class="op">=</span> pd.factorize(d.sir_consciousness_level, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    conciousness <span class="op">=</span> np.ma.masked_equal(conciousness, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    hypotension, _ <span class="op">=</span> pd.factorize(d.SAPS_hypotension, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    hypotension  <span class="op">=</span> np.ma.masked_equal(hypotension, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    hypothermia, _ <span class="op">=</span> pd.factorize(d.SAPS_hypothermia, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    hypothermia  <span class="op">=</span> np.ma.masked_equal(hypothermia, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    hypoxia, _ <span class="op">=</span> pd.factorize(d.SAPS_hypoxia, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    hypoxia  <span class="op">=</span> np.ma.masked_equal(hypoxia, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    acidosis, _ <span class="op">=</span> pd.factorize(d.SAPS_acidosis, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    acidosis  <span class="op">=</span> np.ma.masked_equal(acidosis, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Varying intercept with non-centered parameterization</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    mu_bar0 <span class="op">=</span> pm.Normal(<span class="st">'alpha_bar0'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    sigma_bar0 <span class="op">=</span> pm.Exponential(<span class="st">'sigma_bar0'</span>, <span class="dv">1</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    z_beta0 <span class="op">=</span> pm.Normal(<span class="st">'z_beta0'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    beta_0 <span class="op">=</span> pm.Deterministic(<span class="st">'beta_0'</span>, mu_bar0 <span class="op">+</span> z_beta0 <span class="op">*</span> sigma_bar0, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for female (0/1)</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    beta_female <span class="op">=</span> pm.Normal(<span class="st">'beta_female'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for afterhours (0/1) </span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    beta_icu_admission_afterhours <span class="op">=</span> pm.Normal(<span class="st">'beta_icu_admission_afterhours'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for std_age</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    beta_age <span class="op">=</span> pm.Normal(<span class="st">'beta_age'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Intercepts for (categorical) conciousness level with missing data (separate distributions per dx group) handling non-centered parameterization,</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    p_con <span class="op">=</span> pm.Dirichlet(<span class="st">'p_con'</span>, a<span class="op">=</span>np.ones((<span class="dv">13</span>,<span class="dv">5</span>)), dims<span class="op">=</span>(<span class="st">'dx'</span>, <span class="st">'sir_consciousness_level'</span>))</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    conciousness_imputed <span class="op">=</span> pm.Categorical(<span class="st">'con_imputed'</span>, p<span class="op">=</span>p_con[idx_dx,:], dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>conciousness)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    mu_bar_conciousness <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_conciousness'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    sigma_bar_conciousness <span class="op">=</span> pm.Exponential(<span class="st">'sigma_bar_conciousness'</span>, <span class="dv">1</span>)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    z_beta_conciousness <span class="op">=</span> pm.Normal(<span class="st">'z_beta_conciousness'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sir_consciousness_level'</span>)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    beta_conciousness <span class="op">=</span> pm.Deterministic(<span class="st">'beta_conciousness'</span>, mu_bar_conciousness <span class="op">+</span> z_beta_conciousness <span class="op">*</span> sigma_bar_conciousness, dims<span class="op">=</span><span class="st">'sir_consciousness_level'</span>)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for hypotension with missing data handling (non hierarchical imputation) </span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    p_hypotension <span class="op">=</span> pm.Normal(<span class="st">'p_hypotension'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    hypotension_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'hypotension_imputed'</span>, logit_p<span class="op">=</span>p_hypotension, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>hypotension)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    beta_hypotension <span class="op">=</span> pm.Normal(<span class="st">'beta_hypotension'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for hypothermia with missing data handling (non hierarchical imputation)</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    p_hypothermia <span class="op">=</span> pm.Normal(<span class="st">'p_hypothermia'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    hypothermia_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'hypothermia_imputed'</span>, logit_p<span class="op">=</span>p_hypothermia, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>hypothermia)</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    beta_hypothermia <span class="op">=</span> pm.Normal(<span class="st">'beta_hypothermia'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for hypoxia with missing data handling (non hierarchical imputation)</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    p_hypoxia <span class="op">=</span> pm.Normal(<span class="st">'p_hypoxia'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    hypoxia_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'hypoxia_imputed'</span>, logit_p<span class="op">=</span>p_hypoxia, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>hypoxia)</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    beta_hypoxia <span class="op">=</span> pm.Normal(<span class="st">'beta_hypoxia'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for acidosis with missing data handling (non hierarchical imputation)</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    p_acidosis <span class="op">=</span> pm.Normal(<span class="st">'p_acidosis'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    acidosis_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'acidosis_imputed'</span>, logit_p<span class="op">=</span>p_acidosis, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>acidosis)</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    beta_acidosis <span class="op">=</span> pm.Normal(<span class="st">'beta_acidosis'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    p_i <span class="op">=</span> pm.Deterministic(<span class="st">'p_i'</span>, beta_0[idx_dx] <span class="op">+</span> beta_female <span class="op">*</span> female <span class="op">+</span> beta_icu_admission_afterhours <span class="op">*</span> icu_admission_afterhours <span class="op">+</span> beta_age <span class="op">*</span> age <span class="op">+</span> beta_conciousness[conciousness_imputed] <span class="op">+</span> beta_hypotension <span class="op">*</span> hypotension_imputed <span class="op">+</span> beta_hypothermia <span class="op">*</span> hypothermia_imputed <span class="op">+</span> beta_hypoxia <span class="op">*</span> hypoxia_imputed <span class="op">+</span> beta_acidosis <span class="op">*</span> acidosis_imputed, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> pm.Bernoulli(<span class="st">'Y'</span>, logit_p<span class="op">=</span>p_i, observed<span class="op">=</span>d[<span class="st">'d30'</span>], dims<span class="op">=</span><span class="st">'sample'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in con_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in hypotension_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in hypothermia_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in hypoxia_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in acidosis_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="5">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> m1_2:</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    idata_1_2 <span class="op">=</span> pm.sample()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Multiprocess sampling (4 chains in 4 jobs)
CompoundStep
&gt;NUTS: [alpha_bar0, sigma_bar0, z_beta0, beta_female, beta_icu_admission_afterhours, beta_age, p_con, mu_bar_conciousness, sigma_bar_conciousness, z_beta_conciousness, p_hypotension, beta_hypotension, p_hypothermia, beta_hypothermia, p_hypoxia, beta_hypoxia, p_acidosis, beta_acidosis]
&gt;CategoricalGibbsMetropolis: [con_imputed_unobserved]
&gt;BinaryGibbsMetropolis: [hypotension_imputed_unobserved, hypothermia_imputed_unobserved, hypoxia_imputed_unobserved, acidosis_imputed_unobserved]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 8248 seconds.
There were 13 divergences after tuning. Increase `target_accept` or reparameterize.
The rhat statistic is larger than 1.01 for some parameters. This indicates problems during sampling. See https://arxiv.org/abs/1903.08008 for details</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 2:17:27&lt;00:00 Sampling 4 chains, 13 divergences]
    </div>
    
</div>
</div>
</section>
<section id="posteriors-of-model-1-parameters" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="posteriors-of-model-1-parameters"><span class="header-section-number">4.3</span> Posteriors of model 1 parameters</h3>
<div class="cell" data-execution_count="57">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_forest(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    [idata_1_1, idata_1_2],</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    model_names<span class="op">=</span>[</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model 1.1'</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model 1.2'</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    kind<span class="op">=</span><span class="st">'ridgeplot'</span>, ess<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    r_hat<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    ridgeplot_overlap<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[<span class="st">'maroon'</span>, <span class="st">'grey'</span>],</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    hdi_prob<span class="op">=</span><span class="fl">0.94</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    combined<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    var_names<span class="op">=</span>[</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'beta_0'</span>,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">'beta_age'</span>,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'beta_conciousness'</span>,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'beta_icu_admission_afterhours'</span>,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'beta_female'</span>,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'beta_hypotension'</span>,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'beta_hypothermia'</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'beta_hypoxia'</span>,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'beta_acidosis'</span>], </span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">10</span>))</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Estimated θ for risk models'</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="risk-model_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
<section id="comments-on-model-1" class="level4" data-number="4.3.1">
<h4 data-number="4.3.1" class="anchored" data-anchor-id="comments-on-model-1"><span class="header-section-number">4.3.1</span> Comments on model 1</h4>
<p>Both models seem to share the same predictors for 30-day mortality. Increasing age, lower levels of conciousness and hypotension seem to predict mortality. To a lesser extent hypoxia, hypothermia and acidosis predict mortality. The intercepts for AIS, ICH, ASAH and TUM tend to be higher, reflecting higher mortality risks in these groups.</p>
<p>In essence, there is nothing interesting to see here. Being old and/or sick is bad. However, it would be interesting to compare these patients with non-transfers and find that some predictors are more/less important in any of the groups.</p>
</section>
</section>
</section>
<section id="model-2-1" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="model-2-1"><span class="header-section-number">5</span> Model 2</h2>
<p>N/A</p>
</section>
<section id="model-3-1" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="model-3-1"><span class="header-section-number">6</span> Model 3</h2>
<p>Here, distance will be used as a predictor. Model 3.1 will model distance with varying slopes where receving centers will be a level. Model 3.2 will model distance with varying slopes where diagnostic group will be a level. Varying <span class="math inline">\beta_{0}</span> intercepts are used in both models. The slopes/intercepts for the other predictors are completely pooled.</p>
<section id="model-3.1" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="model-3.1"><span class="header-section-number">6.1</span> Model 3.1</h3>
<div class="cell" data-execution_count="6">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>COORDS <span class="op">=</span> {<span class="st">'sample'</span>: np.arange(<span class="bu">len</span>(d)), <span class="st">'hospital_type'</span>: pd.factorize(d[<span class="st">'sir_hospital_type'</span>], sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'center'</span>: pd.factorize(d[<span class="st">'tertiary_center'</span>], sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'dx'</span>: pd.factorize(d[<span class="st">'DX'</span>], use_na_sentinel<span class="op">=</span><span class="va">False</span>, sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'sir_consciousness_level'</span>: pd.factorize(d[<span class="st">'sir_consciousness_level'</span>], use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>]}</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>COORDS) <span class="im">as</span> m3_1:</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    idx_dx, _ <span class="op">=</span> pd.factorize(d[<span class="st">'DX'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    idx_center, _ <span class="op">=</span> pd.factorize(d[<span class="st">'tertiary_center'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    idx_center_type, _ <span class="op">=</span> pd.factorize(d[<span class="st">'sir_hospital_type'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    distance <span class="op">=</span> zscore(d.road_distance)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    female <span class="op">=</span> d[<span class="st">'sex_female'</span>]</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    icu_admission_afterhours <span class="op">=</span> d[<span class="st">'icu_admission_afterhours'</span>]</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    age <span class="op">=</span> zscore(d[<span class="st">'age'</span>])</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    conciousness, _ <span class="op">=</span> pd.factorize(d.sir_consciousness_level, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    conciousness <span class="op">=</span> np.ma.masked_equal(conciousness, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    hypotension, _ <span class="op">=</span> pd.factorize(d.SAPS_hypotension, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    hypotension  <span class="op">=</span> np.ma.masked_equal(hypotension, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    hypothermia, _ <span class="op">=</span> pd.factorize(d.SAPS_hypothermia, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    hypothermia  <span class="op">=</span> np.ma.masked_equal(hypothermia, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    hypoxia, _ <span class="op">=</span> pd.factorize(d.SAPS_hypoxia, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    hypoxia  <span class="op">=</span> np.ma.masked_equal(hypoxia, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    acidosis, _ <span class="op">=</span> pd.factorize(d.SAPS_acidosis, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    acidosis  <span class="op">=</span> np.ma.masked_equal(acidosis, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># varying intercept</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    mu_bar_0 <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_0'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    sigma_bar_0 <span class="op">=</span> pm.Exponential(<span class="st">'sigma_bar_0'</span>, <span class="dv">1</span>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    z_beta_0 <span class="op">=</span> pm.Normal(<span class="st">'z_beta_0'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    beta_0 <span class="op">=</span> pm.Deterministic(<span class="st">'beta_0'</span>, mu_bar_0 <span class="op">+</span> z_beta_0 <span class="op">*</span> sigma_bar_0, dims<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># varying slope for distance</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    mu_bar_distance <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_distance'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    sigma_bar_distance <span class="op">=</span> pm.Exponential(<span class="st">'sigma_bar_distance'</span>, <span class="dv">1</span>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    z_beta_distance <span class="op">=</span> pm.Normal(<span class="st">'z_beta_distance'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    beta_distance <span class="op">=</span> pm.Deterministic(<span class="st">'beta_distance'</span>, mu_bar_distance <span class="op">+</span> z_beta_distance <span class="op">*</span> sigma_bar_distance, dims<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed slope, impact of age</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    beta_age <span class="op">=</span> pm.Normal(<span class="st">'beta_age'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed intercept, impact of conciousness</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    p_con <span class="op">=</span> pm.Dirichlet(<span class="st">'p_con'</span>, a<span class="op">=</span>np.ones(<span class="dv">5</span>), dims<span class="op">=</span>(<span class="st">'sir_consciousness_level'</span>))</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    conciousness_imputed <span class="op">=</span> pm.Categorical(<span class="st">'con_imputed'</span>, p<span class="op">=</span>p_con, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>conciousness)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    beta_conciousness <span class="op">=</span> pm.Normal(<span class="st">'beta_conciousness'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sir_consciousness_level'</span>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed intercepts, impact of sending hospital type</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    beta_hospital_type <span class="op">=</span> pm.Normal(<span class="st">'beta_hospital_type'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'hospital_type'</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># adjust for dx</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    beta_dx_group <span class="op">=</span> pm.Normal(<span class="st">'beta_dx_group'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for hypotension with missing data handling (non hierarchical imputation) </span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    p_hypotension <span class="op">=</span> pm.Normal(<span class="st">'p_hypotension'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    hypotension_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'hypotension_imputed'</span>, logit_p<span class="op">=</span>p_hypotension, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>hypotension)</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    beta_hypotension <span class="op">=</span> pm.Normal(<span class="st">'beta_hypotension'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    p_i <span class="op">=</span> pm.Deterministic(<span class="st">'p_i'</span>, beta_0[idx_center] <span class="op">+</span> beta_dx_group[idx_dx] <span class="op">+</span>  beta_distance[idx_center] <span class="op">*</span> distance <span class="op">+</span> beta_hospital_type[idx_center_type] <span class="op">+</span> beta_conciousness[conciousness_imputed] <span class="op">+</span>  beta_age <span class="op">*</span> age <span class="op">+</span> beta_hypotension <span class="op">*</span> hypotension_imputed, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> pm.Bernoulli(<span class="st">'Y'</span>, logit_p<span class="op">=</span>p_i, observed<span class="op">=</span>d[<span class="st">'d30'</span>], dims<span class="op">=</span><span class="st">'sample'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in con_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in hypotension_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> m3_1:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    idata_3_1 <span class="op">=</span> pm.sample()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Multiprocess sampling (4 chains in 4 jobs)
CompoundStep
&gt;NUTS: [mu_bar_0, sigma_bar_0, z_beta_0, mu_bar_distance, sigma_bar_distance, z_beta_distance, beta_age, p_con, beta_conciousness, beta_hospital_type, beta_dx_group, p_hypotension, beta_hypotension]
&gt;CategoricalGibbsMetropolis: [con_imputed_unobserved]
&gt;BinaryGibbsMetropolis: [hypotension_imputed_unobserved]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 566 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 09:25&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
</section>
<section id="model-3.2" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="model-3.2"><span class="header-section-number">6.2</span> Model 3.2</h3>
<div class="cell" data-execution_count="9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>COORDS <span class="op">=</span> {<span class="st">'sample'</span>: np.arange(<span class="bu">len</span>(d)), <span class="st">'hospital_type'</span>: pd.factorize(d[<span class="st">'sir_hospital_type'</span>], sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'center'</span>: pd.factorize(d[<span class="st">'tertiary_center'</span>], sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'dx'</span>: pd.factorize(d[<span class="st">'DX'</span>], use_na_sentinel<span class="op">=</span><span class="va">False</span>, sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'sir_consciousness_level'</span>: pd.factorize(d[<span class="st">'sir_consciousness_level'</span>], use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>]}</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>COORDS) <span class="im">as</span> m3_2:</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    idx_dx, _ <span class="op">=</span> pd.factorize(d[<span class="st">'DX'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    idx_center, _ <span class="op">=</span> pd.factorize(d[<span class="st">'tertiary_center'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    idx_center_type, _ <span class="op">=</span> pd.factorize(d[<span class="st">'sir_hospital_type'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    distance <span class="op">=</span> zscore(d.road_distance)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    female <span class="op">=</span> d[<span class="st">'sex_female'</span>]</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    icu_admission_afterhours <span class="op">=</span> d[<span class="st">'icu_admission_afterhours'</span>]</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    age <span class="op">=</span> zscore(d[<span class="st">'age'</span>])</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    conciousness, _ <span class="op">=</span> pd.factorize(d.sir_consciousness_level, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    conciousness <span class="op">=</span> np.ma.masked_equal(conciousness, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    hypotension, _ <span class="op">=</span> pd.factorize(d.SAPS_hypotension, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    hypotension  <span class="op">=</span> np.ma.masked_equal(hypotension, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    hypothermia, _ <span class="op">=</span> pd.factorize(d.SAPS_hypothermia, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    hypothermia  <span class="op">=</span> np.ma.masked_equal(hypothermia, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    hypoxia, _ <span class="op">=</span> pd.factorize(d.SAPS_hypoxia, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    hypoxia  <span class="op">=</span> np.ma.masked_equal(hypoxia, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    acidosis, _ <span class="op">=</span> pd.factorize(d.SAPS_acidosis, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    acidosis  <span class="op">=</span> np.ma.masked_equal(acidosis, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># varying intercept</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    mu_bar_0 <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_0'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    sigma_bar_0 <span class="op">=</span> pm.Exponential(<span class="st">'sigma_bar_0'</span>, <span class="dv">1</span>)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    z_beta_0 <span class="op">=</span> pm.Normal(<span class="st">'z_beta_0'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    beta_0 <span class="op">=</span> pm.Deterministic(<span class="st">'beta_0'</span>, mu_bar_0 <span class="op">+</span> z_beta_0 <span class="op">*</span> sigma_bar_0, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># varying slope for distance</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    mu_bar_distance <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_distance'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    sigma_bar_distance <span class="op">=</span> pm.Exponential(<span class="st">'sigma_bar_distance'</span>, <span class="dv">1</span>)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    z_beta_distance <span class="op">=</span> pm.Normal(<span class="st">'z_beta_distance'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    beta_distance <span class="op">=</span> pm.Deterministic(<span class="st">'beta_distance'</span>, mu_bar_distance <span class="op">+</span> z_beta_distance <span class="op">*</span> sigma_bar_distance, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed slope, impact of age</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    beta_age <span class="op">=</span> pm.Normal(<span class="st">'beta_age'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed intercept, impact of conciousness</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    p_con <span class="op">=</span> pm.Dirichlet(<span class="st">'p_con'</span>, a<span class="op">=</span>np.ones(<span class="dv">5</span>), dims<span class="op">=</span>(<span class="st">'sir_consciousness_level'</span>))</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    conciousness_imputed <span class="op">=</span> pm.Categorical(<span class="st">'con_imputed'</span>, p<span class="op">=</span>p_con, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>conciousness)</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    beta_conciousness <span class="op">=</span> pm.Normal(<span class="st">'beta_conciousness'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sir_consciousness_level'</span>)</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed intercepts, impact of sending hospital type</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    beta_hospital_type <span class="op">=</span> pm.Normal(<span class="st">'beta_hospital_type'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'hospital_type'</span>)</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># adjust for center</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    beta_center <span class="op">=</span> pm.Normal(<span class="st">'beta_center'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for hypotension with missing data handling (non hierarchical imputation) </span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    p_hypotension <span class="op">=</span> pm.Normal(<span class="st">'p_hypotension'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>    hypotension_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'hypotension_imputed'</span>, logit_p<span class="op">=</span>p_hypotension, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>hypotension)</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    beta_hypotension <span class="op">=</span> pm.Normal(<span class="st">'beta_hypotension'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>    p_i <span class="op">=</span> pm.Deterministic(<span class="st">'p_i'</span>, beta_0[idx_dx] <span class="op">+</span>  beta_center[idx_center] <span class="op">+</span> beta_distance[idx_dx] <span class="op">*</span> distance <span class="op">+</span> beta_hospital_type[idx_center_type] <span class="op">+</span> beta_conciousness[conciousness_imputed] <span class="op">+</span>  beta_age <span class="op">*</span> age <span class="op">+</span> beta_hypotension <span class="op">*</span> hypotension_imputed, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> pm.Bernoulli(<span class="st">'Y'</span>, logit_p<span class="op">=</span>p_i, observed<span class="op">=</span>d[<span class="st">'d30'</span>], dims<span class="op">=</span><span class="st">'sample'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in con_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in hypotension_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="10">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> m3_2:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    idata_3_2 <span class="op">=</span> pm.sample()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Multiprocess sampling (4 chains in 4 jobs)
CompoundStep
&gt;NUTS: [mu_bar_0, sigma_bar_0, z_beta_0, mu_bar_distance, sigma_bar_distance, z_beta_distance, beta_age, p_con, beta_conciousness, beta_hospital_type, beta_center, p_hypotension, beta_hypotension]
&gt;CategoricalGibbsMetropolis: [con_imputed_unobserved]
&gt;BinaryGibbsMetropolis: [hypotension_imputed_unobserved]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 580 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 09:40&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
</section>
<section id="posteriors-of-model-3-parameters" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="posteriors-of-model-3-parameters"><span class="header-section-number">6.3</span> Posteriors of model 3 parameters</h3>
<div class="cell" data-execution_count="58">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_forest(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    [idata_3_1, idata_3_2],</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    model_names<span class="op">=</span>[</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model 3.1'</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model 3.2'</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    kind<span class="op">=</span><span class="st">'ridgeplot'</span>, ess<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    r_hat<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[<span class="st">'navy'</span>, <span class="st">'darkorange'</span>],</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    ridgeplot_overlap<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    hdi_prob<span class="op">=</span><span class="fl">0.94</span>,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    combined<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    var_names<span class="op">=</span>[<span class="st">'beta_0'</span>, <span class="st">'beta_age'</span>, <span class="st">'beta_hypotension'</span>, <span class="st">'beta_conciousness'</span>, <span class="st">'beta_hospital_type'</span>,<span class="st">'beta_center'</span>,<span class="st">'beta_distance'</span>,],</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">10</span>))</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Estimated θ for risk models'</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="risk-model_files/figure-html/cell-12-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Only the distance parameters now:</p>
<div class="cell" data-execution_count="62">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_forest(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    [idata_3_1, idata_3_2],</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    model_names<span class="op">=</span>[</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model 3.1'</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model 3.2'</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    kind<span class="op">=</span><span class="st">'ridgeplot'</span>, ess<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    r_hat<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[<span class="st">'navy'</span>, <span class="st">'darkorange'</span>],</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    ridgeplot_overlap<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    hdi_prob<span class="op">=</span><span class="fl">0.94</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    combined<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    var_names<span class="op">=</span>[<span class="st">'beta_distance'</span>,])</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Estimated θ for risk models'</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="risk-model_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<section id="comments" class="level4" data-number="6.3.1">
<h4 data-number="6.3.1" class="anchored" data-anchor-id="comments"><span class="header-section-number">6.3.1</span> Comments</h4>
<p>Again, being older, hypotensive and less concious is bad. Distance has no clear predictive role nomatter the model specification (dx or centers as levels).</p>
</section>
</section>
</section>
<section id="model-4-1" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="model-4-1"><span class="header-section-number">7</span> Model 4</h2>
<p>In model 4.1 the sending center will define the top level of hierarchy. Varying intercept and slope for effect of standardized time in ICU. The other predictor coefficients are completely pooled. In model 4.2 the diagnostic group will define the top level instead. Receiving center is a predictor. Otherwise the model structure is the same as in model 4.1.</p>
<div class="cell" data-execution_count="87">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>COORDS <span class="op">=</span> {<span class="st">'sample'</span>: np.arange(<span class="bu">len</span>(d)), <span class="st">'hospital_type'</span>: pd.factorize(d[<span class="st">'sir_hospital_type'</span>], sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'center'</span>: pd.factorize(d[<span class="st">'formatted_icu_name'</span>], sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'dx'</span>: pd.factorize(d[<span class="st">'DX'</span>], use_na_sentinel<span class="op">=</span><span class="va">False</span>, sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'sir_consciousness_level'</span>: pd.factorize(d[<span class="st">'sir_consciousness_level'</span>], use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>]}</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>COORDS) <span class="im">as</span> m4_1:</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    idx_dx, _ <span class="op">=</span> pd.factorize(d[<span class="st">'DX'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    idx_center, _ <span class="op">=</span> pd.factorize(d[<span class="st">'formatted_icu_name'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    idx_center_type, _ <span class="op">=</span> pd.factorize(d[<span class="st">'sir_hospital_type'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    distance <span class="op">=</span> zscore(d.road_distance)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    female <span class="op">=</span> d[<span class="st">'sex_female'</span>]</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    icu_admission_afterhours <span class="op">=</span> d[<span class="st">'icu_admission_afterhours'</span>]</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    age <span class="op">=</span> zscore(d[<span class="st">'age'</span>])</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    conciousness, _ <span class="op">=</span> pd.factorize(d.sir_consciousness_level, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    conciousness <span class="op">=</span> np.ma.masked_equal(conciousness, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    hypotension, _ <span class="op">=</span> pd.factorize(d.SAPS_hypotension, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    hypotension  <span class="op">=</span> np.ma.masked_equal(hypotension, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    hypothermia, _ <span class="op">=</span> pd.factorize(d.SAPS_hypothermia, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    hypothermia  <span class="op">=</span> np.ma.masked_equal(hypothermia, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    hypoxia, _ <span class="op">=</span> pd.factorize(d.SAPS_hypoxia, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    hypoxia  <span class="op">=</span> np.ma.masked_equal(hypoxia, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    acidosis, _ <span class="op">=</span> pd.factorize(d.SAPS_acidosis, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    acidosis  <span class="op">=</span> np.ma.masked_equal(acidosis, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    time <span class="op">=</span> zscore(d[<span class="st">'sir_total_time'</span>])</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># varying intercept</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    mu_bar_0 <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_0'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    sigma_bar_0 <span class="op">=</span> pm.Exponential(<span class="st">'sigma_bar_0'</span>, <span class="dv">1</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    z_beta_0 <span class="op">=</span> pm.Normal(<span class="st">'z_beta_0'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    beta_0 <span class="op">=</span> pm.Deterministic(<span class="st">'beta_0'</span>, mu_bar_0 <span class="op">+</span> z_beta_0 <span class="op">*</span> sigma_bar_0, dims<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># varying slope for time</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    mu_bar_time <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_time'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    sigma_bar_time <span class="op">=</span> pm.Exponential(<span class="st">'sigma_bar_time'</span>, <span class="dv">1</span>)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    z_beta_time <span class="op">=</span> pm.Normal(<span class="st">'z_beta_time'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    beta_time <span class="op">=</span> pm.Deterministic(<span class="st">'beta_time'</span>, mu_bar_time <span class="op">+</span> z_beta_time <span class="op">*</span> sigma_bar_time, dims<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed slope, impact of age</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    beta_age <span class="op">=</span> pm.Normal(<span class="st">'beta_age'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed slope, impact of female</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>    beta_female <span class="op">=</span> pm.Normal(<span class="st">'beta_female'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed intercept, impact of conciousness</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    p_con <span class="op">=</span> pm.Dirichlet(<span class="st">'p_con'</span>, a<span class="op">=</span>np.ones(<span class="dv">5</span>), dims<span class="op">=</span>(<span class="st">'sir_consciousness_level'</span>))</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    conciousness_imputed <span class="op">=</span> pm.Categorical(<span class="st">'con_imputed'</span>, p<span class="op">=</span>p_con, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>conciousness)</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>    beta_conciousness <span class="op">=</span> pm.Normal(<span class="st">'beta_conciousness'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sir_consciousness_level'</span>)</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for hypotension with missing data handling (non hierarchical imputation) </span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    p_hypotension <span class="op">=</span> pm.Normal(<span class="st">'p_hypotension'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>    hypotension_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'hypotension_imputed'</span>, logit_p<span class="op">=</span>p_hypotension, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>hypotension)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    beta_hypotension <span class="op">=</span> pm.Normal(<span class="st">'beta_hypotension'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for hypothermia with missing data handling (non hierarchical imputation)</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    p_hypothermia <span class="op">=</span> pm.Normal(<span class="st">'p_hypothermia'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>    hypothermia_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'hypothermia_imputed'</span>, logit_p<span class="op">=</span>p_hypothermia, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>hypothermia)</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    beta_hypothermia <span class="op">=</span> pm.Normal(<span class="st">'beta_hypothermia'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for hypoxia with missing data handling (non hierarchical imputation)</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>    p_hypoxia <span class="op">=</span> pm.Normal(<span class="st">'p_hypoxia'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>    hypoxia_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'hypoxia_imputed'</span>, logit_p<span class="op">=</span>p_hypoxia, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>hypoxia)</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>    beta_hypoxia <span class="op">=</span> pm.Normal(<span class="st">'beta_hypoxia'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for acidosis with missing data handling (non hierarchical imputation)</span></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>    p_acidosis <span class="op">=</span> pm.Normal(<span class="st">'p_acidosis'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    acidosis_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'acidosis_imputed'</span>, logit_p<span class="op">=</span>p_acidosis, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>acidosis)</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>    beta_acidosis <span class="op">=</span> pm.Normal(<span class="st">'beta_acidosis'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># intercepts for dx group</span></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>    beta_dx_group <span class="op">=</span> pm.Normal(<span class="st">'beta_dx_group'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>    p_i <span class="op">=</span> pm.Deterministic(<span class="st">'p_i'</span>, beta_0[idx_center] <span class="op">+</span> beta_time[idx_center] <span class="op">*</span> time <span class="op">+</span> beta_female <span class="op">*</span> beta_female <span class="op">+</span> beta_conciousness[conciousness_imputed] <span class="op">+</span> beta_age <span class="op">*</span> age <span class="op">+</span> beta_hypotension <span class="op">*</span> hypotension_imputed <span class="op">+</span> beta_hypothermia <span class="op">*</span> hypotension_imputed <span class="op">+</span> beta_hypoxia <span class="op">*</span> hypoxia_imputed <span class="op">+</span> beta_acidosis <span class="op">*</span> acidosis_imputed <span class="op">+</span> beta_dx_group[idx_dx], dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> pm.Bernoulli(<span class="st">'Y'</span>, logit_p<span class="op">=</span>p_i, observed<span class="op">=</span>d[<span class="st">'d30'</span>], dims<span class="op">=</span><span class="st">'sample'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in con_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in hypotension_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in hypothermia_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in hypoxia_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in acidosis_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="88">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> m4_1:</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    idata_4_1 <span class="op">=</span> pm.sample()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Multiprocess sampling (4 chains in 4 jobs)
CompoundStep
&gt;NUTS: [mu_bar_0, sigma_bar_0, z_beta_0, mu_bar_time, sigma_bar_time, z_beta_time, beta_age, beta_female, p_con, beta_conciousness, p_hypotension, beta_hypotension, p_hypothermia, beta_hypothermia, p_hypoxia, beta_hypoxia, p_acidosis, beta_acidosis, beta_dx_group]
&gt;CategoricalGibbsMetropolis: [con_imputed_unobserved]
&gt;BinaryGibbsMetropolis: [hypotension_imputed_unobserved, hypothermia_imputed_unobserved, hypoxia_imputed_unobserved, acidosis_imputed_unobserved]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 7921 seconds.
There were 201 divergences after tuning. Increase `target_accept` or reparameterize.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 2:12:01&lt;00:00 Sampling 4 chains, 201 divergences]
    </div>
    
</div>
</div>
<div class="cell" data-execution_count="92">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_forest(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    [idata_4_1],</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    model_names<span class="op">=</span>[</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model 4.1'</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    kind<span class="op">=</span><span class="st">'ridgeplot'</span>, ess<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    r_hat<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[<span class="st">'darkolivegreen'</span>],</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    ridgeplot_overlap<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    hdi_prob<span class="op">=</span><span class="fl">0.94</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    combined<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    var_names<span class="op">=</span>[<span class="st">'beta_time'</span>, <span class="st">'mu_bar_time'</span>, <span class="st">'beta_age'</span>, <span class="st">'beta_dx_group'</span>, <span class="st">'beta_conciousness'</span>])</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Estimated θ for risk models'</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="risk-model_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Time spent in primary ICU is not predicitve of 30-day mortality. Finally, let’s try a model where diagnostic group is the top level. The choice of covariates is a more limited set to decrease sampling time.</p>
<div class="cell" data-execution_count="103">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>COORDS <span class="op">=</span> {<span class="st">'sample'</span>: np.arange(<span class="bu">len</span>(d)), <span class="st">'hospital_type'</span>: pd.factorize(d[<span class="st">'sir_hospital_type'</span>], sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'center'</span>: pd.factorize(d[<span class="st">'tertiary_center'</span>], sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'dx'</span>: pd.factorize(d[<span class="st">'DX'</span>], use_na_sentinel<span class="op">=</span><span class="va">False</span>, sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>], <span class="st">'sir_consciousness_level'</span>: pd.factorize(d[<span class="st">'sir_consciousness_level'</span>], use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>]}</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>COORDS) <span class="im">as</span> m4_2:</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    idx_dx, _ <span class="op">=</span> pd.factorize(d[<span class="st">'DX'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    idx_center, _ <span class="op">=</span> pd.factorize(d[<span class="st">'tertiary_center'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    idx_center_type, _ <span class="op">=</span> pd.factorize(d[<span class="st">'sir_hospital_type'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    distance <span class="op">=</span> zscore(d.road_distance)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    female <span class="op">=</span> d[<span class="st">'sex_female'</span>]</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    icu_admission_afterhours <span class="op">=</span> d[<span class="st">'icu_admission_afterhours'</span>]</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    age <span class="op">=</span> zscore(d[<span class="st">'age'</span>])</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    conciousness, _ <span class="op">=</span> pd.factorize(d.sir_consciousness_level, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    conciousness <span class="op">=</span> np.ma.masked_equal(conciousness, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    hypotension, _ <span class="op">=</span> pd.factorize(d.SAPS_hypotension, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    hypotension  <span class="op">=</span> np.ma.masked_equal(hypotension, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    hypothermia, _ <span class="op">=</span> pd.factorize(d.SAPS_hypothermia, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    hypothermia  <span class="op">=</span> np.ma.masked_equal(hypothermia, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    hypoxia, _ <span class="op">=</span> pd.factorize(d.SAPS_hypoxia, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    hypoxia  <span class="op">=</span> np.ma.masked_equal(hypoxia, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    acidosis, _ <span class="op">=</span> pd.factorize(d.SAPS_acidosis, use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    acidosis  <span class="op">=</span> np.ma.masked_equal(acidosis, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    time <span class="op">=</span> zscore(d[<span class="st">'sir_total_time'</span>])</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># varying intercept</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    mu_bar_0 <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_0'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    sigma_bar_0 <span class="op">=</span> pm.Exponential(<span class="st">'sigma_bar_0'</span>, <span class="dv">1</span>)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    z_beta_0 <span class="op">=</span> pm.Normal(<span class="st">'z_beta_0'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    beta_0 <span class="op">=</span> pm.Deterministic(<span class="st">'beta_0'</span>, mu_bar_0 <span class="op">+</span> z_beta_0 <span class="op">*</span> sigma_bar_0, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># varying slope for time</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    mu_bar_time <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_time'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    sigma_bar_time <span class="op">=</span> pm.Exponential(<span class="st">'sigma_bar_time'</span>, <span class="dv">1</span>)</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    z_beta_time <span class="op">=</span> pm.Normal(<span class="st">'z_beta_time'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    beta_time <span class="op">=</span> pm.Deterministic(<span class="st">'beta_time'</span>, mu_bar_time <span class="op">+</span> z_beta_time <span class="op">*</span> sigma_bar_time, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed slope, impact of age</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    beta_age <span class="op">=</span> pm.Normal(<span class="st">'beta_age'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">#fixed intercept, impact of conciousness</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    p_con <span class="op">=</span> pm.Dirichlet(<span class="st">'p_con'</span>, a<span class="op">=</span>np.ones(<span class="dv">5</span>), dims<span class="op">=</span>(<span class="st">'sir_consciousness_level'</span>))</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>    conciousness_imputed <span class="op">=</span> pm.Categorical(<span class="st">'con_imputed'</span>, p<span class="op">=</span>p_con, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>conciousness)</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>    beta_conciousness <span class="op">=</span> pm.Normal(<span class="st">'beta_conciousness'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sir_consciousness_level'</span>)</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">#slope for hypotension with missing data handling (non hierarchical imputation) </span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    p_hypotension <span class="op">=</span> pm.Normal(<span class="st">'p_hypotension'</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>    hypotension_imputed <span class="op">=</span> pm.Bernoulli(<span class="st">'hypotension_imputed'</span>, logit_p<span class="op">=</span>p_hypotension, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>hypotension)</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>    beta_hypotension <span class="op">=</span> pm.Normal(<span class="st">'beta_hypotension'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for hypothermia with missing data handling (non hierarchical imputation)</span></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  p_hypothermia = pm.Normal('p_hypothermia', -2, 2)</span></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  hypothermia_imputed = pm.Bernoulli('hypothermia_imputed', logit_p=p_hypothermia, dims='sample', observed=hypothermia)</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  beta_hypothermia = pm.Normal('beta_hypothermia', 0, 1)</span></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for hypoxia with missing data handling (non hierarchical imputation)</span></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>   <span class="co"># p_hypoxia = pm.Normal('p_hypoxia', -2, 2)</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>   <span class="co"># hypoxia_imputed = pm.Bernoulli('hypoxia_imputed', logit_p=p_hypoxia, dims='sample', observed=hypoxia)</span></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>   <span class="co"># beta_hypoxia = pm.Normal('beta_hypoxia', 0, 1)</span></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slope for acidosis with missing data handling (non hierarchical imputation)</span></span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">#p_acidosis = pm.Normal('p_acidosis', -2, 2)</span></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">#acidosis_imputed = pm.Bernoulli('acidosis_imputed', logit_p=p_acidosis, dims='sample', observed=acidosis)</span></span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">#beta_acidosis = pm.Normal('beta_acidosis', 0, 1)</span></span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed slope, impact of female</span></span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>    beta_female <span class="op">=</span> pm.Normal(<span class="st">'beta_female'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># adjust for receiving center</span></span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a>    beta_center <span class="op">=</span> pm.Normal(<span class="st">'beta_center'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a>    p_i <span class="op">=</span> pm.Deterministic(<span class="st">'p_i'</span>, beta_0[idx_dx] <span class="op">+</span> beta_time[idx_dx] <span class="op">*</span> time <span class="op">+</span> beta_female <span class="op">*</span> female <span class="op">+</span> beta_age <span class="op">*</span> age <span class="op">+</span> beta_center[idx_center] <span class="op">+</span> beta_conciousness[conciousness_imputed] <span class="op">+</span> beta_hypotension <span class="op">*</span> hypotension_imputed, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> pm.Bernoulli(<span class="st">'Y'</span>, logit_p<span class="op">=</span>p_i, observed<span class="op">=</span>d[<span class="st">'d30'</span>], dims<span class="op">=</span><span class="st">'sample'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in con_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in hypotension_imputed contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="104">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> m4_2:</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    idata_4_2 <span class="op">=</span> pm.sample()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Multiprocess sampling (4 chains in 4 jobs)
CompoundStep
&gt;NUTS: [mu_bar_0, sigma_bar_0, z_beta_0, mu_bar_time, sigma_bar_time, z_beta_time, beta_age, p_con, beta_conciousness, p_hypotension, beta_hypotension, beta_female, beta_center]
&gt;CategoricalGibbsMetropolis: [con_imputed_unobserved]
&gt;BinaryGibbsMetropolis: [hypotension_imputed_unobserved]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 569 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 09:28&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
<div class="cell" data-execution_count="107">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_forest(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    [idata_4_2],</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    model_names<span class="op">=</span>[</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model 4.2'</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    kind<span class="op">=</span><span class="st">'ridgeplot'</span>, ess<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    r_hat<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[<span class="st">'grey'</span>],</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    ridgeplot_overlap<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    hdi_prob<span class="op">=</span><span class="fl">0.94</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    combined<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    var_names<span class="op">=</span>[<span class="st">'beta_conciousness'</span>, <span class="st">'beta_hypotension'</span>, <span class="st">'beta_age'</span>, <span class="st">'beta_center'</span>, <span class="st">'beta_female'</span>, <span class="st">'beta_time'</span>, <span class="st">'mu_bar_time'</span>])</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Estimated θ for risk models'</span>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="risk-model_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Conclusion: time-in-primary ICU is not an important predictor for 30-day mortality.</p>
</section>
<section id="what-did-we-learn" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="what-did-we-learn"><span class="header-section-number">8</span> What did we learn?</h2>
<p>Nothing. Age, hypotension, low GCS, hypothermia, acidosis, hypoxia, ICH, AIS and TBI are all bad. Time in primary ICU is not an important predictor of 30-day mortality.</p>
<div class="cell" data-execution_count="11">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext watermark</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>watermark <span class="op">-</span>n <span class="op">-</span>u <span class="op">-</span>v <span class="op">-</span>iv <span class="op">-</span>w <span class="op">-</span>p pytensor,xarray,pymc,arviz,pandas</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The watermark extension is already loaded. To reload it, use:
  %reload_ext watermark
Last updated: Fri May 03 2024

Python implementation: CPython
Python version       : 3.11.9
IPython version      : 8.22.2

pytensor: 2.19.0
xarray  : 2024.3.0
pymc    : 5.12.0
arviz   : 0.18.0
pandas  : 2.2.2

Watermark: 2.4.3
</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>