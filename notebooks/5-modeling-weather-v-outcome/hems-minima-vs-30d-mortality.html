<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.306">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-05-03">

<title>Causal effect of HEMS minima on 30-day mortality</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="hems-minima-vs-30d-mortality_files/libs/clipboard/clipboard.min.js"></script>
<script src="hems-minima-vs-30d-mortality_files/libs/quarto-html/quarto.js"></script>
<script src="hems-minima-vs-30d-mortality_files/libs/quarto-html/popper.min.js"></script>
<script src="hems-minima-vs-30d-mortality_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="hems-minima-vs-30d-mortality_files/libs/quarto-html/anchor.min.js"></script>
<link href="hems-minima-vs-30d-mortality_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="hems-minima-vs-30d-mortality_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="hems-minima-vs-30d-mortality_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="hems-minima-vs-30d-mortality_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="hems-minima-vs-30d-mortality_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#model-defintions" id="toc-model-defintions" class="nav-link active" data-scroll-target="#model-defintions"><span class="header-section-number">1</span> Model defintions</a>
  <ul class="collapse">
  <li><a href="#linear-model" id="toc-linear-model" class="nav-link" data-scroll-target="#linear-model"><span class="header-section-number">1.1</span> Linear model</a></li>
  </ul></li>
  <li><a href="#linear-model-with-less-conservative-priors" id="toc-linear-model-with-less-conservative-priors" class="nav-link" data-scroll-target="#linear-model-with-less-conservative-priors"><span class="header-section-number">2</span> Linear model with less conservative priors</a></li>
  <li><a href="#fbli-model" id="toc-fbli-model" class="nav-link" data-scroll-target="#fbli-model"><span class="header-section-number">3</span> FBLI model</a></li>
  <li><a href="#hsgp" id="toc-hsgp" class="nav-link" data-scroll-target="#hsgp"><span class="header-section-number">4</span> HSGP</a></li>
  <li><a href="#counterfactial-estimation" id="toc-counterfactial-estimation" class="nav-link" data-scroll-target="#counterfactial-estimation"><span class="header-section-number">5</span> Counterfactial estimation</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">6</span> Conclusion</a>
  <ul class="collapse">
  <li><a href="#bonus-a-small-sanity-check" id="toc-bonus-a-small-sanity-check" class="nav-link" data-scroll-target="#bonus-a-small-sanity-check"><span class="header-section-number">6.1</span> Bonus: a small sanity check</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Causal effect of HEMS minima on 30-day mortality</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Johan Olsson </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 3, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<div class="cell" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load dependencies</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> zscore</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.special <span class="im">import</span> expit</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pymc <span class="im">import</span> do, observe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="4">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>hems_d <span class="op">=</span> pd.read_csv(<span class="st">'/Users/JO/PhD/neurocritical-transfers/notes/final-analysis/5-modeling-weather-v-outcome/hems_d.csv'</span>, index_col<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="5">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>d_point <span class="op">=</span> hems_d.dropna(axis<span class="op">=</span><span class="dv">0</span>, subset<span class="op">=</span><span class="st">'both_point_hems_minima'</span>).copy()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>d_window <span class="op">=</span> hems_d.dropna(axis<span class="op">=</span><span class="dv">0</span>, subset<span class="op">=</span><span class="st">'both_hems_minima_window'</span>).copy()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> d_point</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>n_samples <span class="op">=</span> <span class="bu">len</span>(data)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>SAMPLE <span class="op">=</span> np.arange(n_samples)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>HEMS_MINIMA, TREATMENT <span class="op">=</span>  pd.factorize(data[<span class="st">'both_point_hems_minima'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>SENDING_CENTER_IDX, SENDING_CENTER <span class="op">=</span>  pd.factorize(data[<span class="st">'sir_icu_name'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>RECEIVING_CENTER_IDX, RECEIVING_CENTER <span class="op">=</span> pd.factorize(data[<span class="st">'tertiary_center'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>MONTH_IDX, MONTH <span class="op">=</span> pd.factorize(data[<span class="st">'utc_month'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>DAY_IDX, DAY <span class="op">=</span> pd.factorize(data[<span class="st">'utc_day'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>HOUR_IDX, HOUR <span class="op">=</span> pd.factorize(data[<span class="st">'admission_hour_utc'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>DAYLIGHT_IDX, DAYLIGHT <span class="op">=</span> pd.factorize(data[<span class="st">'sending_daylight'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>AFTERHOURS_IDX, AFTERHOURS <span class="op">=</span> pd.factorize(data[<span class="st">'icu_admission_afterhours'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>DX_IDX, DX <span class="op">=</span> pd.factorize(data[<span class="st">'DX'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>AGE_STD <span class="op">=</span> zscore(data[<span class="st">'age'</span>])</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>FEMALE_IDX, FEMALE <span class="op">=</span> pd.factorize(data[<span class="st">'sex_female'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>CONCIOUSNESS_IDX, CONCIOUSNESS <span class="op">=</span> pd.factorize(data[<span class="st">'sir_consciousness_level'</span>], use_na_sentinel<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>CONCIOUSNESS_IDX <span class="op">=</span> np.ma.masked_equal(CONCIOUSNESS_IDX, <span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="model-defintions" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="model-defintions"><span class="header-section-number">1</span> Model defintions</h2>
<section id="linear-model" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="linear-model"><span class="header-section-number">1.1</span> Linear model</h3>
<div class="cell" data-execution_count="6">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>COORDS <span class="op">=</span> {<span class="st">'sample'</span>: SAMPLE, <span class="st">'treatment'</span>: TREATMENT, <span class="st">'sending_center'</span>: SENDING_CENTER, <span class="st">'daylight'</span>: DAYLIGHT, <span class="st">'afterhours'</span>: AFTERHOURS, <span class="st">'month'</span>: MONTH, <span class="st">'hour'</span>: HOUR, <span class="st">'AGE_STD'</span>: AGE_STD, <span class="st">'dx'</span>: DX, <span class="st">'conciousness'</span>: CONCIOUSNESS}</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>COORDS) <span class="im">as</span> linear_model:</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Input data variables</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment exposure</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pm.Bernoulli(<span class="st">'X'</span>, p<span class="op">=</span><span class="fl">.75</span>, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    p_MONTH <span class="op">=</span> pm.Dirichlet(<span class="st">'p_M'</span>, a<span class="op">=</span>np.ones(<span class="dv">12</span>))</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#p_DAY = pm.Dirichlet('p_DAY', a=np.ones(366))</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    p_HOUR <span class="op">=</span> pm.Dirichlet(<span class="st">'p_H'</span>, a<span class="op">=</span>np.ones(<span class="dv">24</span>))</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    p_DAYLIGHT <span class="op">=</span> pm.Beta(<span class="st">'p_D'</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    p_SENDING_CENTER <span class="op">=</span> pm.Dirichlet(<span class="st">'p_SC'</span>, a<span class="op">=</span>np.ones(<span class="bu">len</span>(SENDING_CENTER)))</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    p_DX <span class="op">=</span> pm.Dirichlet(<span class="st">'p_DX'</span>, a<span class="op">=</span>np.ones(<span class="bu">len</span>(DX))<span class="op">/</span><span class="bu">len</span>(DX))</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    p_CONCIOUSNESS <span class="op">=</span> pm.Dirichlet(<span class="st">'p_CONCIOUSNESS'</span>, a<span class="op">=</span>np.ones(<span class="bu">len</span>(CONCIOUSNESS))<span class="op">/</span><span class="bu">len</span>(CONCIOUSNESS))</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    month <span class="op">=</span> pm.Categorical(<span class="st">'MONTH'</span>, p<span class="op">=</span>p_MONTH, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#day = pm.Categorical('DAY', p=p_DAY, dims='sample')</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    hour <span class="op">=</span> pm.Categorical(<span class="st">'HOUR'</span>, p<span class="op">=</span>p_HOUR, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    daylight <span class="op">=</span> pm.Bernoulli(<span class="st">'DAYLIGHT'</span>, p<span class="op">=</span>p_DAYLIGHT, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    afterhours <span class="op">=</span> pm.Bernoulli(<span class="st">'AFTERHOURS'</span>, p<span class="op">=</span><span class="fl">.75</span>, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Other variables</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    age_std <span class="op">=</span> pm.Normal(<span class="st">'AGE_STD'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    dx <span class="op">=</span> pm.Categorical(<span class="st">'DX'</span>, p<span class="op">=</span>p_DX, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    conciousness_imputed <span class="op">=</span> pm.Categorical(<span class="st">'CONCIOUSNESS'</span>, p<span class="op">=</span>p_CONCIOUSNESS, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>CONCIOUSNESS_IDX)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    center <span class="op">=</span> pm.Categorical(<span class="st">'CENTER'</span>, p<span class="op">=</span>p_SENDING_CENTER, dims<span class="op">=</span><span class="st">'sample'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in CONCIOUSNESS contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> linear_model: </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Intercept</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rationale the mu_bar_prior comes from that I expect the "baseline" mortality risk is approx 20%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The sigma bar prior essentially says that the between center differences are probably small, but that it is not </span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># impossible that variations could be large (moratlity risk x1.5-2 between centers)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    mu_bar_beta_0 <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_beta_0'</span>, <span class="op">-</span><span class="dv">1</span>, <span class="fl">.25</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    sigma_bar_beta_0 <span class="op">=</span> pm.HalfNormal(<span class="st">'sigma_bar_beta_0'</span>, <span class="fl">.2</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    z_beta_0 <span class="op">=</span> pm.Normal(<span class="st">'z_beta_0'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    beta_0 <span class="op">=</span> pm.Deterministic(<span class="st">'beta_0'</span>, mu_bar_beta_0 <span class="op">+</span> z_beta_0 <span class="op">*</span> sigma_bar_beta_0, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment effect</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I expect the treatment effect to be very small. Almost zero. The real impact of a high functionining</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HEMS system might be 2-3% on the average patient. Here, we are actually testing the HEMS weather minima.</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Therefore the effect must be diluted by a factor of 2-3 as most transfers will not be undertaken by such a system anyways.</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># While the effect is small, there can quite singificant variation between centers</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    mu_bar_beta_x <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_beta_x'</span>, <span class="dv">0</span>, <span class="fl">.1</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    sigma_bar_beta_x <span class="op">=</span> pm.HalfNormal(<span class="st">'sigma_bar_beta_x'</span>, <span class="fl">.1</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    z_beta_x <span class="op">=</span> pm.Normal(<span class="st">'z_beta_x'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    beta_x <span class="op">=</span> pm.Deterministic(<span class="st">'beta_x'</span>, mu_bar_beta_x <span class="op">+</span> z_beta_x <span class="op">*</span> sigma_bar_beta_x, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confounding effects of time</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I expect the effect size to a few percent for most patients</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    beta_month <span class="op">=</span> pm.Normal(<span class="st">'beta_month'</span>, <span class="dv">0</span>, <span class="fl">.15</span>, dims<span class="op">=</span><span class="st">'month'</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>   <span class="co"># beta_hour = pm.Normal('beta_hour', 0, .15, dims='hour')</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    beta_afterhours <span class="op">=</span> pm.Normal(<span class="st">'beta_afterhours'</span>, <span class="dv">0</span>, <span class="fl">.3</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Non-confounders</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I expect the effect of diagnosis to be larger than that of age. A change of 1 std dev age might have an effect of +/- 5-10% on mortality</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The effect of dx is larger and the effect of concioussness even a bit larger</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    beta_dx <span class="op">=</span> pm.Normal(<span class="st">'beta_dx'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    beta_age <span class="op">=</span> pm.Normal(<span class="st">'beta_age'</span>, <span class="fl">0.5</span>, <span class="fl">.75</span>)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    beta_conciousness <span class="op">=</span> pm.Normal(<span class="st">'beta_conciousness'</span>, <span class="dv">0</span>, <span class="fl">.75</span>, dims<span class="op">=</span><span class="st">'conciousness'</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    beta_daylight <span class="op">=</span> pm.Normal(<span class="st">'beta_daylight'</span>, <span class="dv">0</span>, <span class="fl">.1</span>)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome model</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    p_i <span class="op">=</span> pm.Deterministic(<span class="st">'p_y'</span>, beta_0[center] <span class="op">+</span> beta_x[center] <span class="op">*</span> x <span class="op">+</span> beta_daylight <span class="op">*</span> daylight <span class="op">+</span> beta_month[month] <span class="op">+</span> beta_afterhours <span class="op">*</span> afterhours <span class="op">+</span> beta_dx[dx] <span class="op">+</span> beta_conciousness[conciousness_imputed] <span class="op">+</span> beta_age <span class="op">*</span> age_std, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> pm.Bernoulli(<span class="st">'Y'</span>, logit_p<span class="op">=</span>p_i, dims<span class="op">=</span><span class="st">'sample'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="priors" class="level4" data-number="1.1.1">
<h4 data-number="1.1.1" class="anchored" data-anchor-id="priors"><span class="header-section-number">1.1.1</span> Priors</h4>
<p>Understanding implications of prior choices is diffucult just looking at distributional assumptions. Here, we will plot implications of the priors on the outcome scale (probability of d30 mortality).</p>
<div class="cell" data-execution_count="8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> linear_model:</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    prior <span class="op">=</span> pm.sample_prior_predictive(<span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [AFTERHOURS, AGE_STD, CENTER, CONCIOUSNESS_observed, CONCIOUSNESS_unobserved, DAYLIGHT, DX, HOUR, MONTH, X, Y, beta_afterhours, beta_age, beta_conciousness, beta_daylight, beta_dx, beta_month, mu_bar_beta_0, mu_bar_beta_x, p_CONCIOUSNESS, p_D, p_DX, p_H, p_M, p_SC, sigma_bar_beta_0, sigma_bar_beta_x, z_beta_0, z_beta_x]</code></pre>
</div>
</div>
<p>First, let’s see the priors for variation in outcome between the sending centers. Substantial variation should be allowed.</p>
<div class="cell" data-execution_count="9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> xr.DataArray(np.linspace(<span class="dv">0</span>, <span class="dv">15</span>, <span class="dv">16</span>).astype(<span class="bu">int</span>), dims<span class="op">=</span>[<span class="st">"sending_center"</span>],)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>priors <span class="op">=</span> prior.prior</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> expit(priors[<span class="st">"beta_0"</span>])</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>ax.plot(x, y.stack(sample<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>)), c<span class="op">=</span><span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Predictor (center_idx)"</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Mean Outcome (p_death)"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Prior predictive checks"</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>(0.0, 1.0)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="hems-minima-vs-30d-mortality_files/figure-html/cell-8-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Next, let’s see the prior implications on differences in outcome between months.</p>
<div class="cell" data-execution_count="10">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>x_month <span class="op">=</span> xr.DataArray(np.linspace(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">12</span>).astype(<span class="bu">int</span>), dims<span class="op">=</span>[<span class="st">"month"</span>],)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> expit(priors[<span class="st">'mu_bar_beta_0'</span>] <span class="op">+</span> priors[<span class="st">"beta_month"</span>])</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>ax.plot(x_month, y.stack(sample<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>)), c<span class="op">=</span><span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Predictor (month)"</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Mean Outcome (p_death)"</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Prior predictive checks"</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>(0.0, 1.0)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="hems-minima-vs-30d-mortality_files/figure-html/cell-9-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Now, the effect of concioussness levels on outcome.</p>
<div class="cell" data-execution_count="11">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> xr.DataArray(np.linspace(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">5</span>).astype(<span class="bu">int</span>), dims<span class="op">=</span>[<span class="st">"conciousness"</span>],)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> expit(priors[<span class="st">"beta_conciousness"</span>])</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>ax.plot(x, y.stack(sample<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>)), c<span class="op">=</span><span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Predictor (conciousness)"</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Mean Outcome (p_death)"</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Prior predictive checks"</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>(0.0, 1.0)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="hems-minima-vs-30d-mortality_files/figure-html/cell-10-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Priors for treatment effects and the treatment effect variation between centers. To make the plot less busy, we only plot for the case where the “baseline” mortality risk is approximately 25%.</p>
<div class="cell" data-execution_count="12">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> xr.DataArray(np.linspace(<span class="dv">0</span>, <span class="dv">15</span>, <span class="dv">16</span>).astype(<span class="bu">int</span>), dims<span class="op">=</span>[<span class="st">"sending_center"</span>],)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>y0 <span class="op">=</span> expit(<span class="op">-</span><span class="dv">1</span> <span class="op">+</span> <span class="dv">0</span><span class="op">*</span>priors[<span class="st">"beta_x"</span>])</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>y1 <span class="op">=</span> expit(<span class="op">-</span><span class="dv">1</span> <span class="op">+</span> <span class="dv">1</span><span class="op">*</span>priors[<span class="st">"beta_x"</span>])</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>ax.plot(x, y0.stack(sample<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>)), c<span class="op">=</span><span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>ax.plot(x, y1.stack(sample<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>)), c<span class="op">=</span><span class="st">"darkgrey"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Treatment effect at center_idx"</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Mean Outcome (p_death)"</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Prior predictive checks"</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>(0.0, 1.0)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="hems-minima-vs-30d-mortality_files/figure-html/cell-11-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Now, standardized age vs.&nbsp;outcome. Here with a baseline risk of a little under 20%.</p>
<div class="cell" data-execution_count="13">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>x_std_age <span class="op">=</span> xr.DataArray(np.linspace(<span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">51</span>), dims<span class="op">=</span>[<span class="st">"age"</span>])</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> expit(<span class="op">-</span><span class="dv">2</span> <span class="op">+</span> priors[<span class="st">"beta_age"</span>] <span class="op">*</span> x_std_age)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate over columns of y and plot each one against x_std_age</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(y.shape[<span class="dv">1</span>]):</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    ax.plot(x_std_age, y[:, i].squeeze(), c<span class="op">=</span><span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Predictor (std_age)"</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Mean Outcome (p_death)"</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Prior predictive checks"</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="hems-minima-vs-30d-mortality_files/figure-html/cell-12-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Priors for the effect of diagnosis on outcome.</p>
<div class="cell" data-execution_count="14">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>x_dx <span class="op">=</span> xr.DataArray(np.linspace(<span class="dv">1</span>, <span class="dv">13</span>, <span class="dv">13</span>).astype(<span class="bu">int</span>), dims<span class="op">=</span>[<span class="st">"dx"</span>],)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> expit(priors[<span class="st">'mu_bar_beta_0'</span>] <span class="op">+</span> priors[<span class="st">"beta_dx"</span>])</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>ax.plot(x_dx, y.stack(sample<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>)), c<span class="op">=</span><span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Predictor (dx)"</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Mean Outcome (p_death)"</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Prior predictive checks"</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>(0.0, 1.0)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="hems-minima-vs-30d-mortality_files/figure-html/cell-13-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>And here the effect of daylight on outcome. X axis should really be only 0, 1.</p>
<div class="cell" data-execution_count="15">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>x_daylight <span class="op">=</span> xr.DataArray(np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>), dims<span class="op">=</span>[<span class="st">"daylight"</span>])</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> expit(priors[<span class="st">"mu_bar_beta_0"</span>] <span class="op">+</span> priors[<span class="st">"beta_daylight"</span>] <span class="op">*</span> x_daylight)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate over columns of y and plot each one against x_std_age</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(y.shape[<span class="dv">1</span>]):</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    ax.plot(x_daylight, y[:, i].squeeze(), c<span class="op">=</span><span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Predictor (daylight present)"</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Mean Outcome (p_death)"</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Prior predictive checks"</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="hems-minima-vs-30d-mortality_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Afterhours effect:</p>
<div class="cell" data-execution_count="16">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>x_afterhours <span class="op">=</span> xr.DataArray(np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>), dims<span class="op">=</span>[<span class="st">"afterhours"</span>])</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> expit(priors[<span class="st">"mu_bar_beta_0"</span>] <span class="op">+</span> priors[<span class="st">"beta_afterhours"</span>] <span class="op">*</span> x_afterhours)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate over columns of y and plot each one against x_std_age</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(y.shape[<span class="dv">1</span>]):</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    ax.plot(x_afterhours, y[:, i].squeeze(), c<span class="op">=</span><span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Predictor (afterhours present)"</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Mean Outcome (p_death)"</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Prior predictive checks"</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="hems-minima-vs-30d-mortality_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="model-fitting" class="level4" data-number="1.1.2">
<h4 data-number="1.1.2" class="anchored" data-anchor-id="model-fitting"><span class="header-section-number">1.1.2</span> Model fitting</h4>
<p>All in all, most priors are conservative, but at least roughly represent my idea of the world. Next, let’s fit the model.</p>
<div class="cell" data-execution_count="17">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>observations<span class="op">=</span>{<span class="st">'X'</span>: HEMS_MINIMA, <span class="st">'MONTH'</span>: MONTH_IDX, <span class="st">'HOUR'</span>: HOUR_IDX, <span class="st">'AFTERHOURS'</span>: AFTERHOURS_IDX, <span class="st">'DAYLIGHT'</span>: DAYLIGHT_IDX, <span class="st">'DX'</span>: DX_IDX, <span class="st">'AGE_STD'</span>: AGE_STD, <span class="st">'CENTER'</span>: SENDING_CENTER_IDX, <span class="st">'Y'</span>: data.d30}</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>model_with_obs <span class="op">=</span> observe(linear_model, observations)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model_with_obs:</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    idata_linear <span class="op">=</span> pm.sample(idata_kwargs<span class="op">=</span>{<span class="st">'log_likelihood'</span>:<span class="va">True</span>} )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Multiprocess sampling (4 chains in 4 jobs)
CompoundStep
&gt;NUTS: [p_M, p_H, p_D, p_SC, p_DX, p_CONCIOUSNESS, mu_bar_beta_0, sigma_bar_beta_0, z_beta_0, mu_bar_beta_x, sigma_bar_beta_x, z_beta_x, beta_month, beta_afterhours, beta_dx, beta_age, beta_conciousness, beta_daylight]
&gt;CategoricalGibbsMetropolis: [CONCIOUSNESS_unobserved]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 80 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 01:19&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
</section>
</section>
</section>
<section id="linear-model-with-less-conservative-priors" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="linear-model-with-less-conservative-priors"><span class="header-section-number">2</span> Linear model with less conservative priors</h2>
<div class="cell" data-execution_count="18">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>COORDS <span class="op">=</span> {<span class="st">'sample'</span>: SAMPLE, <span class="st">'treatment'</span>: TREATMENT, <span class="st">'sending_center'</span>: SENDING_CENTER, <span class="st">'daylight'</span>: DAYLIGHT, <span class="st">'afterhours'</span>: AFTERHOURS, <span class="st">'month'</span>: MONTH, <span class="st">'hour'</span>: HOUR, <span class="st">'AGE_STD'</span>: AGE_STD, <span class="st">'dx'</span>: DX, <span class="st">'conciousness'</span>: CONCIOUSNESS}</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>COORDS) <span class="im">as</span> linear_model_loose:</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Input data variables</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment exposure</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pm.Bernoulli(<span class="st">'X'</span>, p<span class="op">=</span><span class="fl">.75</span>, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    p_MONTH <span class="op">=</span> pm.Dirichlet(<span class="st">'p_M'</span>, a<span class="op">=</span>np.ones(<span class="dv">12</span>))</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#p_DAY = pm.Dirichlet('p_DAY', a=np.ones(366))</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    p_HOUR <span class="op">=</span> pm.Dirichlet(<span class="st">'p_H'</span>, a<span class="op">=</span>np.ones(<span class="dv">24</span>))</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    p_DAYLIGHT <span class="op">=</span> pm.Beta(<span class="st">'p_D'</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    p_SENDING_CENTER <span class="op">=</span> pm.Dirichlet(<span class="st">'p_SC'</span>, a<span class="op">=</span>np.ones(<span class="bu">len</span>(SENDING_CENTER)))</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    p_DX <span class="op">=</span> pm.Dirichlet(<span class="st">'p_DX'</span>, a<span class="op">=</span>np.ones(<span class="bu">len</span>(DX))<span class="op">/</span><span class="bu">len</span>(DX))</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    p_CONCIOUSNESS <span class="op">=</span> pm.Dirichlet(<span class="st">'p_CONCIOUSNESS'</span>, a<span class="op">=</span>np.ones(<span class="bu">len</span>(CONCIOUSNESS))<span class="op">/</span><span class="bu">len</span>(CONCIOUSNESS))</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    month <span class="op">=</span> pm.Categorical(<span class="st">'MONTH'</span>, p<span class="op">=</span>p_MONTH, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#day = pm.Categorical('DAY', p=p_DAY, dims='sample')</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    hour <span class="op">=</span> pm.Categorical(<span class="st">'HOUR'</span>, p<span class="op">=</span>p_HOUR, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    daylight <span class="op">=</span> pm.Bernoulli(<span class="st">'DAYLIGHT'</span>, p<span class="op">=</span>p_DAYLIGHT, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    afterhours <span class="op">=</span> pm.Bernoulli(<span class="st">'AFTERHOURS'</span>, p<span class="op">=</span><span class="fl">.75</span>, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Other variables</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    age_std <span class="op">=</span> pm.Normal(<span class="st">'AGE_STD'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    dx <span class="op">=</span> pm.Categorical(<span class="st">'DX'</span>, p<span class="op">=</span>p_DX, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    conciousness_imputed <span class="op">=</span> pm.Categorical(<span class="st">'CONCIOUSNESS'</span>, p<span class="op">=</span>p_CONCIOUSNESS, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>CONCIOUSNESS_IDX)</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    center <span class="op">=</span> pm.Categorical(<span class="st">'CENTER'</span>, p<span class="op">=</span>p_SENDING_CENTER, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Intercept</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rationale the mu_bar_prior comes from that I expect the "baseline" mortality risk is approx 20%</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The sigma bar prior essentially says that the between center differences are probably small, but that it is not </span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># impossible that variations could be large (moratlity risk x1.5-2 between centers)</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    mu_bar_beta_0 <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_beta_0'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    sigma_bar_beta_0 <span class="op">=</span> pm.HalfNormal(<span class="st">'sigma_bar_beta_0'</span>, <span class="dv">2</span>)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    z_beta_0 <span class="op">=</span> pm.Normal(<span class="st">'z_beta_0'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    beta_0 <span class="op">=</span> pm.Deterministic(<span class="st">'beta_0'</span>, mu_bar_beta_0 <span class="op">+</span> z_beta_0 <span class="op">*</span> sigma_bar_beta_0, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment effect</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I expect the treatment effect to be very small. Almost zero. The real impact of a high functionining</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HEMS system might be 2-3% on the average patient. Here, we are actually testing the HEMS weather minima.</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Therefore the effect must be diluted by a factor of 2-3 as most transfers will not be undertaken by such a system anyways.</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># While the effect is small, there can quite singificant variation between centers</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    mu_bar_beta_x <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_beta_x'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    sigma_bar_beta_x <span class="op">=</span> pm.HalfNormal(<span class="st">'sigma_bar_beta_x'</span>, <span class="dv">2</span>)</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    z_beta_x <span class="op">=</span> pm.Normal(<span class="st">'z_beta_x'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    beta_x <span class="op">=</span> pm.Deterministic(<span class="st">'beta_x'</span>, mu_bar_beta_x <span class="op">+</span> z_beta_x <span class="op">*</span> sigma_bar_beta_x, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confounding effects of time</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I expect the effect size to a few percent for most patients</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>    beta_month <span class="op">=</span> pm.Normal(<span class="st">'beta_month'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'month'</span>)</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>    beta_afterhours <span class="op">=</span> pm.Normal(<span class="st">'beta_afterhours'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Non-confounders</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I expect the effect of diagnosis to be larger than that of age. A change of 1 std dev age might have an effect of +/- 5-10% on mortality</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The effect of dx is larger and the effect of concioussness even a bit larger</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>    beta_dx <span class="op">=</span> pm.Normal(<span class="st">'beta_dx'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>    beta_age <span class="op">=</span> pm.Normal(<span class="st">'beta_age'</span>, <span class="fl">0.5</span>, <span class="dv">2</span>)</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>    beta_conciousness <span class="op">=</span> pm.Normal(<span class="st">'beta_conciousness'</span>, <span class="dv">0</span>, <span class="dv">2</span>, dims<span class="op">=</span><span class="st">'conciousness'</span>)</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>    beta_daylight <span class="op">=</span> pm.Normal(<span class="st">'beta_daylight'</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome model</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>    p_i <span class="op">=</span> pm.Deterministic(<span class="st">'p_y'</span>, beta_0[center] <span class="op">+</span> beta_x[center] <span class="op">*</span> x <span class="op">+</span> beta_daylight <span class="op">*</span> daylight <span class="op">+</span> beta_month[month] <span class="op">+</span> beta_afterhours <span class="op">*</span> afterhours <span class="op">+</span> beta_dx[dx] <span class="op">+</span> beta_conciousness[conciousness_imputed] <span class="op">+</span> beta_age <span class="op">*</span> age_std, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> pm.Bernoulli(<span class="st">'Y'</span>, logit_p<span class="op">=</span>p_i, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>observations<span class="op">=</span>{<span class="st">'X'</span>: HEMS_MINIMA, <span class="st">'MONTH'</span>: MONTH_IDX, <span class="st">'HOUR'</span>: HOUR_IDX, <span class="st">'AFTERHOURS'</span>: AFTERHOURS_IDX, <span class="st">'DAYLIGHT'</span>: DAYLIGHT_IDX, <span class="st">'DX'</span>: DX_IDX, <span class="st">'AGE_STD'</span>: AGE_STD, <span class="st">'CENTER'</span>: SENDING_CENTER_IDX, <span class="st">'Y'</span>: data.d30}</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>model_with_obs <span class="op">=</span> observe(linear_model, observations)</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model_with_obs:</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>    idata_linear_loose <span class="op">=</span> pm.sample(idata_kwargs<span class="op">=</span>{<span class="st">'log_likelihood'</span>:<span class="va">True</span>} )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in CONCIOUSNESS contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)
Multiprocess sampling (4 chains in 4 jobs)
CompoundStep
&gt;NUTS: [p_M, p_H, p_D, p_SC, p_DX, p_CONCIOUSNESS, mu_bar_beta_0, sigma_bar_beta_0, z_beta_0, mu_bar_beta_x, sigma_bar_beta_x, z_beta_x, beta_month, beta_afterhours, beta_dx, beta_age, beta_conciousness, beta_daylight]
&gt;CategoricalGibbsMetropolis: [CONCIOUSNESS_unobserved]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 88 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 01:28&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
</div>
</section>
<section id="fbli-model" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="fbli-model"><span class="header-section-number">3</span> FBLI model</h2>
<p>Here a full luxury bayesian inference models with linear dependencies will be defined. Priors the same as in the linear regression, but with less conservative priors for the effect of month and daylight on HEMS minima.</p>
<div class="cell" data-execution_count="19">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>COORDS <span class="op">=</span> {<span class="st">'sample'</span>: SAMPLE, <span class="st">'treatment'</span>: TREATMENT, <span class="st">'sending_center'</span>: SENDING_CENTER, <span class="st">'daylight'</span>: DAYLIGHT, <span class="st">'afterhours'</span>: AFTERHOURS, <span class="st">'day'</span>: DAY, <span class="st">'month'</span>: MONTH, <span class="st">'hour'</span>: HOUR, <span class="st">'AGE_STD'</span>: AGE_STD, <span class="st">'dx'</span>: DX, <span class="st">'conciousness'</span>: CONCIOUSNESS}</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>COORDS) <span class="im">as</span> FLBI:</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Input data variables</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    p_MONTH <span class="op">=</span> pm.Dirichlet(<span class="st">'p_M'</span>, a<span class="op">=</span>np.ones(<span class="dv">12</span>))</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    p_DAY <span class="op">=</span> pm.Dirichlet(<span class="st">'p_DAY'</span>, a<span class="op">=</span>np.ones(<span class="dv">366</span>))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    p_HOUR <span class="op">=</span> pm.Dirichlet(<span class="st">'p_H'</span>, a<span class="op">=</span>np.ones(<span class="dv">24</span>))</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    p_DAYLIGHT <span class="op">=</span> pm.Beta(<span class="st">'p_D'</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    p_SENDING_CENTER <span class="op">=</span> pm.Dirichlet(<span class="st">'p_SC'</span>, a<span class="op">=</span>np.ones(<span class="bu">len</span>(SENDING_CENTER)))</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    p_DX <span class="op">=</span> pm.Dirichlet(<span class="st">'p_DX'</span>, a<span class="op">=</span>np.ones(<span class="bu">len</span>(DX))<span class="op">/</span><span class="bu">len</span>(DX))</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    p_CONCIOUSNESS <span class="op">=</span> pm.Dirichlet(<span class="st">'p_CONCIOUSNESS'</span>, a<span class="op">=</span>np.ones(<span class="bu">len</span>(CONCIOUSNESS))<span class="op">/</span><span class="bu">len</span>(CONCIOUSNESS))</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    month <span class="op">=</span> pm.Categorical(<span class="st">'MONTH'</span>, p<span class="op">=</span>p_MONTH, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    day <span class="op">=</span> pm.Categorical(<span class="st">'DAY'</span>, p<span class="op">=</span>p_DAY, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    hour <span class="op">=</span> pm.Categorical(<span class="st">'HOUR'</span>, p<span class="op">=</span>p_HOUR, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    daylight <span class="op">=</span> pm.Bernoulli(<span class="st">'DAYLIGHT'</span>, p<span class="op">=</span>p_DAYLIGHT, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    afterhours <span class="op">=</span> pm.Bernoulli(<span class="st">'AFTERHOURS'</span>, p<span class="op">=</span><span class="fl">.75</span>, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Other variables</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    age_std <span class="op">=</span> pm.Normal(<span class="st">'AGE_STD'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    dx <span class="op">=</span> pm.Categorical(<span class="st">'DX'</span>, p<span class="op">=</span>p_DX, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    conciousness_imputed <span class="op">=</span> pm.Categorical(<span class="st">'CONCIOUSNESS'</span>, p<span class="op">=</span>p_CONCIOUSNESS, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>CONCIOUSNESS_IDX)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    center <span class="op">=</span> pm.Categorical(<span class="st">'CENTER'</span>, p<span class="op">=</span>p_SENDING_CENTER, dims<span class="op">=</span><span class="st">'sample'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/model/core.py:1317: ImputationWarning: Data in CONCIOUSNESS contains missing values and will be automatically imputed from the sampling distribution.
  warnings.warn(impute_message, ImputationWarning)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="20">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> FLBI: </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment assignment model</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Month. hour and daylight causes X</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    beta_x_0 <span class="op">=</span> pm.Normal(<span class="st">'beta_x_0'</span>, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    beta_x_month <span class="op">=</span> pm.Normal(<span class="st">'beta_x_month'</span>, <span class="dv">0</span>, <span class="fl">.5</span>, dims<span class="op">=</span><span class="st">'month'</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    beta_x_hour <span class="op">=</span> pm.Normal(<span class="st">'beta_x_hour'</span>, <span class="dv">0</span>, <span class="fl">.5</span>, dims<span class="op">=</span><span class="st">'hour'</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    beta_x_daylight <span class="op">=</span> pm.Normal(<span class="st">'beta_x_daylight'</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    p_x <span class="op">=</span> pm.Deterministic(<span class="st">'p_x'</span>, pm.math.invlogit(beta_x_0 <span class="op">+</span> beta_x_month[month] <span class="op">+</span> beta_x_hour[hour] <span class="op">+</span> beta_x_daylight <span class="op">*</span> daylight))</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pm.Bernoulli(<span class="st">'X'</span>, p<span class="op">=</span>p_x, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome model</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Intercept</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rationale the mu_bar_prior comes from that I expect the "baseline" mortality risk is approx 20%</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The sigma bar prior essentially says that the between center differences are probably small, but that it is not </span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># impossible that variations could be large (moratlity risk x1.5-2 between centers)</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    mu_bar_beta_0 <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_beta_0'</span>, <span class="op">-</span><span class="dv">1</span>, <span class="fl">.1</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    sigma_bar_beta_0 <span class="op">=</span> pm.HalfNormal(<span class="st">'sigma_bar_beta_0'</span>, <span class="fl">.1</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    z_beta_0 <span class="op">=</span> pm.Normal(<span class="st">'z_beta_0'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    beta_0 <span class="op">=</span> pm.Deterministic(<span class="st">'beta_0'</span>, mu_bar_beta_0 <span class="op">+</span> z_beta_0 <span class="op">*</span> sigma_bar_beta_0, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment effect</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I expect the treatment effect to be very small. Almost zero. The real impact of a high functionining</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HEMS system might be 2-3% on the average patient. Here, we are actually testing the HEMS weather minima.</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Therefore the effect must be diluted by a factor of 2-3 as most transfers will not be undertaken by such a system anyways.</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># While the effect is small, there can quite singificant variation between centers</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    mu_bar_beta_x <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_beta_x'</span>, <span class="dv">0</span>, <span class="fl">.1</span>)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    sigma_bar_beta_x <span class="op">=</span> pm.HalfNormal(<span class="st">'sigma_bar_beta_x'</span>, <span class="fl">.1</span>)</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    z_beta_x <span class="op">=</span> pm.Normal(<span class="st">'z_beta_x'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    beta_x <span class="op">=</span> pm.Deterministic(<span class="st">'beta_x'</span>, mu_bar_beta_x <span class="op">+</span> z_beta_x <span class="op">*</span> sigma_bar_beta_x, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confounding effects of time</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    beta_month <span class="op">=</span> pm.Normal(<span class="st">'beta_month'</span>, <span class="dv">0</span>, <span class="fl">.15</span>, dims<span class="op">=</span><span class="st">'month'</span>)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#beta_hour = pm.Normal('beta_hour', 0, .15, dims='hour')</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    beta_afterhours <span class="op">=</span> pm.Normal(<span class="st">'beta_afterhours'</span>, <span class="dv">0</span>, <span class="fl">.3</span>)</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Non-confounders</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    beta_dx <span class="op">=</span> pm.Normal(<span class="st">'beta_dx'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    beta_age <span class="op">=</span> pm.Normal(<span class="st">'beta_age'</span>, <span class="fl">0.5</span>, <span class="fl">.75</span>)</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    beta_conciousness <span class="op">=</span> pm.Normal(<span class="st">'beta_conciousness'</span>, <span class="dv">0</span>, <span class="fl">.75</span>, dims<span class="op">=</span><span class="st">'conciousness'</span>)</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome model</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>    p_i <span class="op">=</span> pm.Deterministic(<span class="st">'p_y'</span>, beta_0[center] <span class="op">+</span> beta_x[center] <span class="op">*</span> x <span class="op">+</span> beta_month[month] <span class="op">+</span> beta_afterhours <span class="op">*</span> afterhours <span class="op">+</span> beta_dx[dx] <span class="op">+</span> beta_conciousness[conciousness_imputed] <span class="op">+</span> beta_age <span class="op">*</span> age_std, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> pm.Bernoulli(<span class="st">'Y'</span>, logit_p<span class="op">=</span>p_i, dims<span class="op">=</span><span class="st">'sample'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="21">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>observations<span class="op">=</span>{<span class="st">'X'</span>: HEMS_MINIMA, <span class="st">'MONTH'</span>: MONTH_IDX, <span class="st">'HOUR'</span>: HOUR_IDX, <span class="st">'AFTERHOURS'</span>: AFTERHOURS_IDX, <span class="st">'DAY'</span>: DAY_IDX, <span class="st">'DAYLIGHT'</span>: DAYLIGHT_IDX, <span class="st">'DX'</span>: DX_IDX, <span class="st">'AGE_STD'</span>: AGE_STD, <span class="st">'CENTER'</span>: SENDING_CENTER_IDX, <span class="st">'Y'</span>: data.d30}</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>flbi_model_with_obs <span class="op">=</span> observe(FLBI, observations)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> flbi_model_with_obs:</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    idata_flbi <span class="op">=</span> pm.sample(idata_kwargs<span class="op">=</span>{<span class="st">'log_likelihood'</span>:<span class="va">True</span>}, target_accept<span class="op">=</span><span class="fl">.95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Multiprocess sampling (4 chains in 4 jobs)
CompoundStep
&gt;NUTS: [p_M, p_DAY, p_H, p_D, p_SC, p_DX, p_CONCIOUSNESS, beta_x_0, beta_x_month, beta_x_hour, beta_x_daylight, mu_bar_beta_0, sigma_bar_beta_0, z_beta_0, mu_bar_beta_x, sigma_bar_beta_x, z_beta_x, beta_month, beta_afterhours, beta_dx, beta_age, beta_conciousness]
&gt;CategoricalGibbsMetropolis: [CONCIOUSNESS_unobserved]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 329 seconds.
There were 1 divergences after tuning. Increase `target_accept` or reparameterize.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 05:28&lt;00:00 Sampling 4 chains, 1 divergences]
    </div>
    
</div>
</div>
</section>
<section id="hsgp" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="hsgp"><span class="header-section-number">4</span> HSGP</h2>
<p>Finally, a full luxury bayesian inference model with GP priors for the effect of time on outcome and treatment in order to allow for potentially better modeling of these effects. This model samples slow when including proper missing data handling.</p>
<div class="cell" data-execution_count="22">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>n_samples <span class="op">=</span> <span class="bu">len</span>(data)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>SAMPLE <span class="op">=</span> np.arange(n_samples)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>HEMS_MINIMA, TREATMENT <span class="op">=</span>  pd.factorize(data[<span class="st">'both_point_hems_minima'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>SENDING_CENTER_IDX, SENDING_CENTER <span class="op">=</span>  pd.factorize(data[<span class="st">'sir_icu_name'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>RECEIVING_CENTER_IDX, RECEIVING_CENTER <span class="op">=</span> pd.factorize(data[<span class="st">'tertiary_center'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>MONTH_IDX, MONTH <span class="op">=</span> pd.factorize(data[<span class="st">'utc_month'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>DAY_IDX, DAY <span class="op">=</span> pd.factorize(data[<span class="st">'utc_day'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>HOUR_IDX, HOUR <span class="op">=</span> pd.factorize(data[<span class="st">'utc_hour'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>DAYLIGHT_IDX, DAYLIGHT <span class="op">=</span> pd.factorize(data[<span class="st">'sending_daylight'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>DX_IDX, DX <span class="op">=</span> pd.factorize(data[<span class="st">'DX'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>AGE_STD <span class="op">=</span> zscore(data[<span class="st">'age'</span>])</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>FEMALE_IDX, FEMALE <span class="op">=</span> pd.factorize(data[<span class="st">'sex_female'</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>CONCIOUSNESS_IDX, CONCIOUSNESS <span class="op">=</span> pd.factorize(data[<span class="st">'sir_consciousness_level'</span>], use_na_sentinel<span class="op">=</span><span class="va">False</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="co">#CONCIOUSNESS_IDX = np.ma.masked_equal(CONCIOUSNESS_IDX, -1)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="85">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>COORDS <span class="op">=</span> {<span class="st">'sample'</span>: SAMPLE, <span class="st">'treatment'</span>: TREATMENT, <span class="st">'sending_center'</span>: SENDING_CENTER, <span class="st">'daylight'</span>: DAYLIGHT, <span class="st">'day'</span>: DAY, <span class="st">'month'</span>: MONTH, <span class="st">'hour'</span>: HOUR, <span class="st">'AGE_STD'</span>: AGE_STD, <span class="st">'dx'</span>: DX, <span class="st">'conciousness'</span>: CONCIOUSNESS}</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>COORDS) <span class="im">as</span> hsgp:</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Input data variables</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment exposure</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    p_MONTH <span class="op">=</span> pm.Dirichlet(<span class="st">'p_M'</span>, a<span class="op">=</span>np.ones(<span class="dv">12</span>))</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    p_DAY <span class="op">=</span> pm.Dirichlet(<span class="st">'p_DAY'</span>, a<span class="op">=</span>np.ones(<span class="dv">366</span>))</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    p_HOUR <span class="op">=</span> pm.Dirichlet(<span class="st">'p_H'</span>, a<span class="op">=</span>np.ones(<span class="dv">24</span>))</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    p_DAYLIGHT <span class="op">=</span> pm.Beta(<span class="st">'p_D'</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    p_SENDING_CENTER <span class="op">=</span> pm.Dirichlet(<span class="st">'p_SC'</span>, a<span class="op">=</span>np.ones(<span class="bu">len</span>(SENDING_CENTER)))</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    p_DX <span class="op">=</span> pm.Dirichlet(<span class="st">'p_DX'</span>, a<span class="op">=</span>np.ones(<span class="bu">len</span>(DX))<span class="op">/</span><span class="bu">len</span>(DX))</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    p_CONCIOUSNESS <span class="op">=</span> pm.Dirichlet(<span class="st">'p_CONCIOUSNESS'</span>, a<span class="op">=</span>np.ones(<span class="bu">len</span>(CONCIOUSNESS))<span class="op">/</span><span class="bu">len</span>(CONCIOUSNESS))</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    month <span class="op">=</span> pm.Categorical(<span class="st">'MONTH'</span>, p<span class="op">=</span>p_MONTH, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    day <span class="op">=</span> pm.Categorical(<span class="st">'DAY'</span>, p<span class="op">=</span>p_DAY, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    hour <span class="op">=</span> pm.Categorical(<span class="st">'HOUR'</span>, p<span class="op">=</span>p_HOUR, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    daylight <span class="op">=</span> pm.Bernoulli(<span class="st">'DAYLIGHT'</span>, p<span class="op">=</span>p_DAYLIGHT, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    afterhours <span class="op">=</span> pm.Bernoulli(<span class="st">'AFTERHOURS'</span>, p<span class="op">=</span><span class="fl">.75</span>, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Other variables</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    age_std <span class="op">=</span> pm.Normal(<span class="st">'AGE_STD'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    dx <span class="op">=</span> pm.Categorical(<span class="st">'DX'</span>, p<span class="op">=</span>p_DX, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    conciousness_imputed <span class="op">=</span> pm.Categorical(<span class="st">'CONCIOUSNESS'</span>, p<span class="op">=</span>p_CONCIOUSNESS, dims<span class="op">=</span><span class="st">'sample'</span>, observed<span class="op">=</span>CONCIOUSNESS_IDX)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    center <span class="op">=</span> pm.Categorical(<span class="st">'CENTER'</span>, p<span class="op">=</span>p_SENDING_CENTER, dims<span class="op">=</span><span class="st">'sample'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="86">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> hsgp:</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># treatment assignemnt</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Month. hour and daylight causes X</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    beta_x_0 <span class="op">=</span> pm.Normal(<span class="st">'beta_x_0'</span>, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    ls_x_MONTH <span class="op">=</span> pm.Gamma(<span class="st">'ls_x_MONTH'</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    eta_x_MONTH <span class="op">=</span> pm.HalfNormal(<span class="st">'eta_x_MONTH'</span>, <span class="dv">1</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    cov_x_MONTH <span class="op">=</span> pm.gp.cov.Periodic(<span class="dv">1</span>, ls<span class="op">=</span>ls_x_MONTH, period<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    gp_x_MONTH <span class="op">=</span> pm.gp.HSGPPeriodic(m<span class="op">=</span><span class="dv">20</span>, cov_func<span class="op">=</span>cov_x_MONTH, scale<span class="op">=</span>eta_x_MONTH<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    f_x_MONTH <span class="op">=</span> gp_x_MONTH.prior(<span class="st">'f_x_MONTH'</span>, X<span class="op">=</span>month[:,<span class="va">None</span>])</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    ls_x_HOUR <span class="op">=</span> pm.Gamma(<span class="st">'ls_x_HOUR'</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    eta_x_HOUR <span class="op">=</span> pm.HalfNormal(<span class="st">'eta_x_HOUR'</span>, <span class="dv">1</span>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    cov_x_HOUR <span class="op">=</span> pm.gp.cov.Periodic(<span class="dv">1</span>, ls<span class="op">=</span>ls_x_HOUR, period<span class="op">=</span><span class="dv">24</span>)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    gp_x_HOUR <span class="op">=</span> pm.gp.HSGPPeriodic(m<span class="op">=</span><span class="dv">20</span>, cov_func<span class="op">=</span>cov_x_HOUR, scale<span class="op">=</span>eta_x_HOUR<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    f_x_HOUR <span class="op">=</span> gp_x_HOUR.prior(<span class="st">'f_x_HOUR'</span>, X<span class="op">=</span>hour[:,<span class="va">None</span>])</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    beta_x_daylight <span class="op">=</span> pm.Normal(<span class="st">'beta_x_daylight'</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    p_x <span class="op">=</span> pm.Deterministic(<span class="st">'p_x'</span>, pm.math.invlogit(beta_x_0 <span class="op">+</span> f_x_MONTH <span class="op">+</span> f_x_HOUR <span class="op">+</span> beta_x_daylight <span class="op">*</span> daylight))</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> pm.Bernoulli(<span class="st">'X'</span>, p<span class="op">=</span>p_x, dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Intercept</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rationale the mu_bar_prior comes from that I expect the "baseline" mortality risk is approx 20%</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The sigma bar prior essentially says that the between center differences are probably small, but that it is not </span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># impossible that variations could be large (moratlity risk x1.5-2 between centers)</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    mu_bar_beta_0 <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_beta_0'</span>, <span class="op">-</span><span class="dv">1</span>, <span class="fl">.25</span>)</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    sigma_bar_beta_0 <span class="op">=</span> pm.HalfNormal(<span class="st">'sigma_bar_beta_0'</span>, <span class="fl">.2</span>)</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    z_beta_0 <span class="op">=</span> pm.Normal(<span class="st">'z_beta_0'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    beta_0 <span class="op">=</span> pm.Deterministic(<span class="st">'beta_0'</span>, mu_bar_beta_0 <span class="op">+</span> z_beta_0 <span class="op">*</span> sigma_bar_beta_0, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment effect</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I expect the treatment effect to be very small. Almost zero. The real impact of a high functionining</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HEMS system might be 2-3% on the average patient. Here, we are actually testing the HEMS weather minima.</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Therefore the effect must be diluted by a factor of 2-3 as most transfers will not be undertaken by such a system anyways.</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># While the effect is small, there can quite singificant variation between centers</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    mu_bar_beta_x <span class="op">=</span> pm.Normal(<span class="st">'mu_bar_beta_x'</span>, <span class="dv">0</span>, <span class="fl">.1</span>)</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    sigma_bar_beta_x <span class="op">=</span> pm.HalfNormal(<span class="st">'sigma_bar_beta_x'</span>, <span class="fl">.1</span>)</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>    z_beta_x <span class="op">=</span> pm.Normal(<span class="st">'z_beta_x'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>    beta_x <span class="op">=</span> pm.Deterministic(<span class="st">'beta_x'</span>, mu_bar_beta_x <span class="op">+</span> z_beta_x <span class="op">*</span> sigma_bar_beta_x, dims<span class="op">=</span><span class="st">'sending_center'</span>)</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confounding effects of time</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>    ls_MONTH <span class="op">=</span> pm.Gamma(<span class="st">'ls_MONTH'</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>    eta_MONTH <span class="op">=</span> pm.HalfNormal(<span class="st">'eta_MONTH'</span>, <span class="dv">1</span>)</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>    cov_MONTH <span class="op">=</span> pm.gp.cov.Periodic(<span class="dv">1</span>, ls<span class="op">=</span>ls_MONTH, period<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>    gp_MONTH <span class="op">=</span> pm.gp.HSGPPeriodic(m<span class="op">=</span><span class="dv">20</span>, cov_func<span class="op">=</span>cov_MONTH, scale<span class="op">=</span>eta_MONTH<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>    f_MONTH <span class="op">=</span> gp_MONTH.prior(<span class="st">'f_MONTH'</span>, X<span class="op">=</span>month[:,<span class="va">None</span>])</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>    ls_HOUR <span class="op">=</span> pm.Gamma(<span class="st">'ls_HOUR'</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>    eta_HOUR <span class="op">=</span> pm.HalfNormal(<span class="st">'eta_HOUR'</span>, <span class="dv">1</span>)</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>    cov_HOUR <span class="op">=</span> pm.gp.cov.Periodic(<span class="dv">1</span>, ls<span class="op">=</span>ls_HOUR, period<span class="op">=</span><span class="dv">24</span>)</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>    gp_HOUR <span class="op">=</span> pm.gp.HSGPPeriodic(m<span class="op">=</span><span class="dv">20</span>, cov_func<span class="op">=</span>cov_HOUR, scale<span class="op">=</span>eta_HOUR<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>    f_HOUR <span class="op">=</span> gp_HOUR.prior(<span class="st">'f_HOUR'</span>, X<span class="op">=</span>hour[:,<span class="va">None</span>])</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Non-confounders</span></span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># I expect the effect of diagnosis to be larger than that of age. A change of 1 std dev age might have an effect of +/- 5-10% on mortality</span></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The effect of dx is larger and the effect of concioussness even a bit larger</span></span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>    beta_dx <span class="op">=</span> pm.Normal(<span class="st">'beta_dx'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'dx'</span>)</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>    beta_age <span class="op">=</span> pm.Normal(<span class="st">'beta_age'</span>, <span class="fl">0.5</span>, <span class="fl">.75</span>)</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>    beta_conciousness <span class="op">=</span> pm.Normal(<span class="st">'beta_conciousness'</span>, <span class="dv">0</span>, <span class="fl">.75</span>, dims<span class="op">=</span><span class="st">'conciousness'</span>)</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>    beta_daylight <span class="op">=</span> pm.Normal(<span class="st">'beta_daylight'</span>, <span class="dv">0</span>, <span class="fl">.1</span>)</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Outcome model</span></span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>    p_i <span class="op">=</span> pm.Deterministic(<span class="st">'p_y'</span>, pm.math.invlogit(beta_0[center] <span class="op">+</span> beta_x[center] <span class="op">*</span> x <span class="op">+</span> beta_daylight <span class="op">*</span> daylight <span class="op">+</span> f_MONTH <span class="op">+</span> f_HOUR <span class="op">+</span> beta_dx[dx] <span class="op">+</span> beta_conciousness[conciousness_imputed] <span class="op">+</span> beta_age <span class="op">*</span> age_std), dims<span class="op">=</span><span class="st">'sample'</span>)</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> pm.Bernoulli(<span class="st">'Y'</span>, p<span class="op">=</span>p_i, dims<span class="op">=</span><span class="st">'sample'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="87">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>observations<span class="op">=</span>{<span class="st">'X'</span>: HEMS_MINIMA, <span class="st">'MONTH'</span>: MONTH_IDX, <span class="st">'HOUR'</span>: HOUR_IDX, <span class="st">'AFTERHOURS'</span>: AFTERHOURS_IDX, <span class="st">'DAY'</span>: DAY_IDX, <span class="st">'DAYLIGHT'</span>: DAYLIGHT_IDX, <span class="st">'DX'</span>: DX_IDX, <span class="st">'AGE_STD'</span>: AGE_STD, <span class="st">'CENTER'</span>: SENDING_CENTER_IDX, <span class="st">'Y'</span>: data.d30}</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co">#observations={'X': HEMS_MINIMA, 'MONTH': MONTH_IDX, 'HOUR': HOUR_IDX, 'AFTERHOURS': AFTERHOURS_IDX, 'DAYLIGHT': DAYLIGHT_IDX, 'DX': DX_IDX, 'AGE_STD': AGE_STD, 'CENTER': SENDING_CENTER_IDX, 'Y': data.d30}</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>hspg_model_with_obs <span class="op">=</span> observe(hsgp, observations)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> hspg_model_with_obs:</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    idata_hsgp <span class="op">=</span> pm.sample(nuts_sampler<span class="op">=</span><span class="st">'nutpie'</span>, idata_kwargs<span class="op">=</span>{<span class="st">'log_likelihood'</span>:<span class="va">True</span>}, target_accept<span class="op">=</span><span class="fl">.9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pytensor/tensor/rewriting/elemwise.py:702: UserWarning: Optimization Warning: The Op iv does not provide a C implementation. As well as being potentially slow, this also disables loop fusion.
  warn(
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pymc/sampling/mcmc.py:292: UserWarning: `idata_kwargs` are currently ignored by the nutpie sampler
  warnings.warn(
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pytensor/tensor/rewriting/elemwise.py:702: UserWarning: Optimization Warning: The Op iv does not provide a C implementation. As well as being potentially slow, this also disables loop fusion.
  warn(
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pytensor/link/numba/dispatch/basic.py:373: UserWarning: Numba will use object mode to run AdvancedSetSubtensor's perform method
  warnings.warn(
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pytensor/tensor/rewriting/elemwise.py:702: UserWarning: Optimization Warning: The Op iv does not provide a C implementation. As well as being potentially slow, this also disables loop fusion.
  warn(
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/pytensor/link/numba/dispatch/basic.py:373: UserWarning: Numba will use object mode to run AdvancedSetSubtensor's perform method
  warnings.warn(
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/nutpie/compile_pymc.py:416: NumbaWarning: Cannot cache compiled function "numba_funcified_fgraph" as it uses dynamic globals (such as ctypes pointers and large global arrays)
  return inner(x)
/Users/JO/miniforge3/envs/epidemiology-pyenv/lib/python3.11/site-packages/nutpie/compile_pymc.py:416: NumbaWarning: Cannot cache compiled function "numba_funcified_fgraph" as it uses dynamic globals (such as ctypes pointers and large global arrays)
  return inner(x)</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 12:18&lt;00:00  Sampling chains: 0, Divergences: 76]
    </div>
    
</div>
</div>
<p>Let’s plot posteriors for some of the coefficients. As we will see, there are no real differences between models. Also</p>
<div class="cell" data-execution_count="93">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> az.plot_forest(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    [idata_linear, idata_linear_loose, idata_flbi,idata_hsgp],</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    model_names<span class="op">=</span>[<span class="st">'linear'</span>, <span class="st">'linear loose priors'</span>, <span class="st">'flbi linear'</span>, <span class="st">'flbi hspg'</span>],</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    kind<span class="op">=</span><span class="st">'ridgeplot'</span>, ess<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    r_hat<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    ridgeplot_overlap<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    hdi_prob<span class="op">=</span><span class="fl">0.98</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    combined<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    var_names<span class="op">=</span>[<span class="st">'mu_bar_beta_x'</span>, <span class="st">'beta_x'</span>, <span class="st">'beta_age'</span>, <span class="st">'beta_x_month'</span>, <span class="st">'beta_month'</span>])</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Estimated θ for models (98% HDI)'</span>)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="hems-minima-vs-30d-mortality_files/figure-html/cell-25-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="counterfactial-estimation" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="counterfactial-estimation"><span class="header-section-number">5</span> Counterfactial estimation</h2>
<p>Let’s estimate the treatment effect in the HSGP model for example. It should be close to 0.</p>
<div class="cell" data-execution_count="110">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>CONCIOUSNESS_IDX, CONCIOUSNESS <span class="op">=</span> pd.factorize(data[<span class="st">'sir_consciousness_level'</span>], use_na_sentinel<span class="op">=</span><span class="va">False</span>, sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>cf_observations<span class="op">=</span>{<span class="st">'MONTH'</span>: MONTH_IDX, <span class="st">'HOUR'</span>: HOUR_IDX, <span class="st">'CONCIOUSNESS'</span>: CONCIOUSNESS_IDX, <span class="st">'AGE_STD'</span>: AGE_STD, <span class="st">'AFTERHOURS'</span>: AFTERHOURS_IDX, <span class="st">'DAY'</span>: DAY_IDX, <span class="st">'DAYLIGHT'</span>: DAYLIGHT_IDX, <span class="st">'DX'</span>: DX_IDX, <span class="st">'CENTER'</span>: SENDING_CENTER_IDX}</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>SEED <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>hsgp_counterfactual <span class="op">=</span> do(hsgp, cf_observations)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>hsgp_do0 <span class="op">=</span> do(hsgp_counterfactual, {<span class="st">'X'</span>: np.zeros(n_samples, dtype<span class="op">=</span><span class="st">'int32'</span>)})</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>hsgp_do1 <span class="op">=</span> do(hsgp_counterfactual, {<span class="st">'X'</span>: np.ones(n_samples, dtype<span class="op">=</span><span class="st">'int32'</span>)})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="116">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>do0_idata <span class="op">=</span> pm.sample_posterior_predictive(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>        idata_hsgp,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>        hsgp_do0,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>        var_names<span class="op">=</span>[<span class="st">'p_y'</span>, <span class="st">'Y'</span>, <span class="st">'X'</span>, <span class="st">'AFTERHOURS'</span>, <span class="st">'CONCIOUSNESS'</span>],</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>        predictions<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>        random_seed<span class="op">=</span>SEED,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>do1_idata <span class="op">=</span> pm.sample_posterior_predictive(</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>        idata_hsgp,</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>        hsgp_do1,</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        var_names<span class="op">=</span>[<span class="st">'p_y'</span>,<span class="st">'Y'</span>, <span class="st">'X'</span>, <span class="st">'AFTERHOURS'</span>, <span class="st">'CONCIOUSNESS'</span>],</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>        predictions<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>        random_seed<span class="op">=</span>SEED,</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [Y]
Sampling: [Y]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="4000" class="" max="4000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [4000/4000 00:00&lt;00:00]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="4000" class="" max="4000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [4000/4000 00:00&lt;00:00]
    </div>
    
</div>
</div>
<div class="cell" data-execution_count="118">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>ate <span class="op">=</span> (do1_idata.predictions.p_y <span class="op">-</span> do0_idata.predictions.p_y).mean(dim<span class="op">=</span><span class="st">'sample'</span>).values</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>az.plot_density(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>ate,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    hdi_prob<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    shade<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    point_estimate<span class="op">=</span><span class="st">'median'</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="op">-</span><span class="fl">.2</span>, <span class="fl">.2</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Estimated ATE of X on p_y'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="hems-minima-vs-30d-mortality_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>I.e. no effect of HEMS minima being met on 30 day mortality.</p>
</section>
<section id="conclusion" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">6</span> Conclusion</h2>
<p>HEMS minima being met does not seem to have an impact on 30-day mortality.</p>
<p>This seems reasonable. My prior belief that a high performing CCT-system will have an absolute mortality benefit of &lt;5% on a population with very high short term mortality risk. (I’m imagining 100 transfers of very sick ICU patients with acute MOF, hemorrhagic chock, critical neuro-ICU conditions, with a 30-40% ICU mortality risk. I can imagine in transit disasters being avoided by the high performing system in maybe 2-3 of these cases. Add to this some nebolous benefit in the slightly longer term.) The mortality benefit in a population with much lower mortality such as here (18%) must be lower. Maybe 2%. Probably lower.</p>
<p>But imagine that it is 2%. Imagine now a set of identical patients exposed to different HEMS minima conditions. In the HEMS minima = 0, group, the mortality will stay at the baseline 18%. In the HEMS minima = 1 group, I suspect that way less than half will be transported by HEMS, further diluting the potential benefit. Also, some patients in the HEMS minima = 0 group will probably be transported by HEMS at a later point than the 2 hour time window I have set up.</p>
<p>Finally, it could be that CCT systems have zero impact on mortality.</p>
<section id="bonus-a-small-sanity-check" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="bonus-a-small-sanity-check"><span class="header-section-number">6.1</span> Bonus: a small sanity check</h3>
<p>Here I will use the frequentist library statsmodels to do a logistic regression with hems minima as a predictor together with confounders. Instead of hour of day I’ve used daylight and “afterhours” to account for diurnal variation. HEMS minima is n.s.</p>
<div class="cell" data-execution_count="143">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>data[<span class="st">'age_std'</span>] <span class="op">=</span> AGE_STD</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>data[<span class="st">'month_factor'</span>] <span class="op">=</span> data.icu_admission_month.astype(<span class="bu">str</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>log_reg <span class="op">=</span> smf.logit(<span class="st">"d30 ~ both_point_hems_minima + age_std + sir_consciousness_level + month_factor + icu_admission_afterhours + sending_daylight"</span>, data<span class="op">=</span>data).fit()</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>log_reg.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Optimization terminated successfully.
         Current function value: 0.329679
         Iterations 7</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="143">
<table class="simpletable table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Logit Regression Results</caption>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Dep. Variable:</td>
<td>d30</td>
<td data-quarto-table-cell-role="th">No. Observations:</td>
<td>2798</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Model:</td>
<td>Logit</td>
<td data-quarto-table-cell-role="th">Df Residuals:</td>
<td>2778</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Method:</td>
<td>MLE</td>
<td data-quarto-table-cell-role="th">Df Model:</td>
<td>19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Date:</td>
<td>Tue, 07 May 2024</td>
<td data-quarto-table-cell-role="th">Pseudo R-squ.:</td>
<td>0.1516</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Time:</td>
<td>09:54:37</td>
<td data-quarto-table-cell-role="th">Log-Likelihood:</td>
<td>-922.44</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">converged:</td>
<td>True</td>
<td data-quarto-table-cell-role="th">LL-Null:</td>
<td>-1087.3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Covariance Type:</td>
<td>nonrobust</td>
<td data-quarto-table-cell-role="th">LLR p-value:</td>
<td>1.580e-58</td>
</tr>
</tbody>
</table>
<table class="simpletable table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td></td>
<td data-quarto-table-cell-role="th">coef</td>
<td data-quarto-table-cell-role="th">std err</td>
<td data-quarto-table-cell-role="th">z</td>
<td data-quarto-table-cell-role="th">P&gt;|z|</td>
<td data-quarto-table-cell-role="th">[0.025</td>
<td data-quarto-table-cell-role="th">0.975]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Intercept</td>
<td>-3.4726</td>
<td>0.292</td>
<td>-11.873</td>
<td>0.000</td>
<td>-4.046</td>
<td>-2.899</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">both_point_hems_minima[T.True]</td>
<td>0.1308</td>
<td>0.196</td>
<td>0.668</td>
<td>0.504</td>
<td>-0.253</td>
<td>0.514</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sir_consciousness_level[T.II (GCS 7-12)]</td>
<td>1.2394</td>
<td>0.158</td>
<td>7.865</td>
<td>0.000</td>
<td>0.931</td>
<td>1.548</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sir_consciousness_level[T.III (GCS 6)]</td>
<td>1.8329</td>
<td>0.213</td>
<td>8.601</td>
<td>0.000</td>
<td>1.415</td>
<td>2.251</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sir_consciousness_level[T.IV (GCS 5)]</td>
<td>2.0666</td>
<td>0.237</td>
<td>8.707</td>
<td>0.000</td>
<td>1.601</td>
<td>2.532</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sir_consciousness_level[T.V (GCS ≤4)]</td>
<td>2.5214</td>
<td>0.188</td>
<td>13.421</td>
<td>0.000</td>
<td>2.153</td>
<td>2.890</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">month_factor[T.10]</td>
<td>-0.2389</td>
<td>0.291</td>
<td>-0.821</td>
<td>0.412</td>
<td>-0.809</td>
<td>0.332</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">month_factor[T.11]</td>
<td>0.0438</td>
<td>0.279</td>
<td>0.157</td>
<td>0.875</td>
<td>-0.502</td>
<td>0.590</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">month_factor[T.12]</td>
<td>-0.0501</td>
<td>0.289</td>
<td>-0.174</td>
<td>0.862</td>
<td>-0.616</td>
<td>0.515</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">month_factor[T.2]</td>
<td>0.1954</td>
<td>0.269</td>
<td>0.725</td>
<td>0.468</td>
<td>-0.333</td>
<td>0.723</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">month_factor[T.3]</td>
<td>-0.0390</td>
<td>0.277</td>
<td>-0.141</td>
<td>0.888</td>
<td>-0.582</td>
<td>0.504</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">month_factor[T.4]</td>
<td>-0.6795</td>
<td>0.310</td>
<td>-2.193</td>
<td>0.028</td>
<td>-1.287</td>
<td>-0.072</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">month_factor[T.5]</td>
<td>-0.5691</td>
<td>0.299</td>
<td>-1.902</td>
<td>0.057</td>
<td>-1.156</td>
<td>0.017</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">month_factor[T.6]</td>
<td>-0.2996</td>
<td>0.292</td>
<td>-1.025</td>
<td>0.306</td>
<td>-0.873</td>
<td>0.274</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">month_factor[T.7]</td>
<td>-0.3327</td>
<td>0.291</td>
<td>-1.144</td>
<td>0.253</td>
<td>-0.903</td>
<td>0.237</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">month_factor[T.8]</td>
<td>-0.9261</td>
<td>0.319</td>
<td>-2.905</td>
<td>0.004</td>
<td>-1.551</td>
<td>-0.301</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">month_factor[T.9]</td>
<td>-0.1968</td>
<td>0.285</td>
<td>-0.691</td>
<td>0.490</td>
<td>-0.756</td>
<td>0.362</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sending_daylight[T.True]</td>
<td>0.5299</td>
<td>0.164</td>
<td>3.230</td>
<td>0.001</td>
<td>0.208</td>
<td>0.851</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">age_std</td>
<td>0.6197</td>
<td>0.073</td>
<td>8.537</td>
<td>0.000</td>
<td>0.477</td>
<td>0.762</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">icu_admission_afterhours</td>
<td>0.2270</td>
<td>0.153</td>
<td>1.486</td>
<td>0.137</td>
<td>-0.072</td>
<td>0.526</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>